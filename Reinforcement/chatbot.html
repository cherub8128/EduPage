<!DOCTYPE html>
<html lang="ko" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Playground: A Hugging Face Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Light Mode Colors */
            --bg-light: #F7F7F8;
            --sidebar-bg-light: rgba(255, 255, 255, 0.6);
            --chat-bg-light: #FFFFFF;
            --user-msg-bg-light: #2563EB;
            --ai-msg-bg-light: #F3F4F6;
            --text-primary-light: #111827;
            --text-secondary-light: #6B7280;
            --border-light: #E5E7EB;
            --accent-light: #2563EB;

            /* Dark Mode Colors */
            --bg-dark: #111111;
            --sidebar-bg-dark: rgba(23, 23, 23, 0.6);
            --chat-bg-dark: #000000;
            --user-msg-bg-dark: #38BDF8;
            --ai-msg-bg-dark: #27272A;
            --text-primary-dark: #E5E7EB;
            --text-secondary-dark: #A1A1AA;
            --border-dark: #3F3F46;
            --accent-dark: #38BDF8;
        }

        .dark {
            --bg: var(--bg-dark);
            --sidebar-bg: var(--sidebar-bg-dark);
            --chat-bg: var(--chat-bg-dark);
            --user-msg-bg: var(--user-msg-bg-dark);
            --ai-msg-bg: var(--ai-msg-bg-dark);
            --text-primary: var(--text-primary-dark);
            --text-secondary: var(--text-secondary-dark);
            --border: var(--border-dark);
            --accent: var(--accent-dark);
        }

        html:not(.dark) {
            --bg: var(--bg-light);
            --sidebar-bg: var(--sidebar-bg-light);
            --chat-bg: var(--chat-bg-light);
            --user-msg-bg: var(--user-msg-bg-light);
            --ai-msg-bg: var(--ai-msg-bg-light);
            --text-primary: var(--text-primary-light);
            --text-secondary: var(--text-secondary-light);
            --border: var(--border-light);
            --accent: var(--accent-light);
        }

        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            background-color: var(--bg);
            color: var(--text-primary);
            overflow: hidden;
        }
        .aurora-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: radial-gradient(ellipse 80% 80% at 50% -20%,rgba(120,119,198,0.15), transparent);
            z-index: -1;
        }
        .sidebar {
            transition: transform 0.3s ease-in-out;
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            background-color: var(--sidebar-bg);
            border: 1px solid var(--border);
        }
        /* Custom Slider */
        input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 4px; background: var(--border); border-radius: 5px; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; background: var(--accent); border-radius: 50%; cursor: pointer; border: 2px solid var(--sidebar-bg); }
        input[type="range"]::-moz-range-thumb { width: 16px; height: 16px; background: var(--accent); border-radius: 50%; cursor: pointer; border: 2px solid var(--sidebar-bg); }
        
        .chat-bubble { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .spinner { border-top-color: var(--accent); animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .modal-backdrop { background-color: rgba(0,0,0,0.6); backdrop-filter: blur(8px); }
        
        /* Custom Scrollbar */
        *::-webkit-scrollbar { width: 6px; }
        *::-webkit-scrollbar-track { background: transparent; }
        *::-webkit-scrollbar-thumb { background-color: var(--border); border-radius: 20px; }
    </style>
</head>
<body>
    <div class="aurora-bg"></div>
    <!-- Sidebar Overlay for mobile -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/60 z-30 lg:hidden hidden"></div>

    <div class="relative h-screen w-screen p-2 sm:p-4">
        <!-- Floating Sidebar -->
        <aside id="sidebar" class="sidebar absolute top-2 sm:top-4 left-2 sm:left-4 bottom-2 sm:bottom-4 w-80 rounded-2xl p-6 z-40 flex flex-col -translate-x-[calc(100%+1rem)] lg:-translate-x-[calc(100%-1.5rem)] lg:hover:translate-x-0 transition-transform duration-300 ease-in-out">
            <div class="flex-1 overflow-y-auto pr-2">
                <h2 class="text-2xl font-bold mb-6 text-[var(--text-primary)]">AI 설정</h2>

                <div class="space-y-6">
                    <!-- API Key -->
                    <div>
                        <label for="api-key" class="text-sm font-semibold text-[var(--text-secondary)]">Hugging Face API Key</label>
                        <input type="password" id="api-key" placeholder="hf_... 토큰을 입력하세요" class="mt-2 w-full bg-[var(--ai-msg-bg)] border border-[var(--border)] rounded-md px-3 py-2 text-sm text-[var(--text-primary)] focus:ring-2 focus:ring-[var(--accent)] focus:outline-none">
                        <a href="https://huggingface.co/settings/tokens" target="_blank" class="text-xs text-[var(--text-secondary)] hover:text-[var(--accent)] transition">Read 권한으로 토큰 받기</a>
                    </div>
                    
                    <!-- Model Selection -->
                    <div>
                        <label for="model-id" class="text-sm font-semibold text-[var(--text-secondary)]">모델 선택</label>
                        <select id="model-task" class="mt-2 w-full bg-[var(--ai-msg-bg)] border border-[var(--border)] rounded-md px-3 py-2 text-sm text-[var(--text-primary)] focus:ring-2 focus:ring-[var(--accent)] focus:outline-none">
                            <option value="text-generation">텍스트 생성 (Text Generation)</option>
                            <option value="text-to-image">이미지 생성 (Text-to-Image)</option>
                            <option value="image-to-text">이미지 설명 (Image-to-Text)</option>
                        </select>
                        <input type="text" id="model-id" value="google/gemma-3-1b-it" class="mt-2 w-full bg-[var(--ai-msg-bg)] border border-[var(--border)] rounded-md px-3 py-2 text-sm text-[var(--text-primary)] focus:ring-2 focus:ring-[var(--accent)] focus:outline-none">
                    </div>

                    <!-- System Prompt -->
                    <div>
                        <label for="system-prompt" class="text-sm font-semibold text-[var(--text-secondary)]">사전 프롬프트</label>
                        <textarea id="system-prompt" rows="4" placeholder="AI의 역할, 페르소나를 지정하세요." class="mt-2 w-full bg-[var(--ai-msg-bg)] border border-[var(--border)] rounded-md px-3 py-2 text-sm text-[var(--text-primary)] focus:ring-2 focus:ring-[var(--accent)] focus:outline-none resize-none"></textarea>
                    </div>

                    <!-- Parameters -->
                    <div>
                        <h3 class="text-sm font-semibold text-[var(--text-secondary)] mb-2">파라미터 튜닝</h3>
                        <div class="space-y-4">
                            <div class="text-xs"><div class="flex justify-between text-[var(--text-secondary)]"><span>Temperature</span><span id="temperature-value">0.7</span></div><input id="temperature" type="range" min="0.1" max="2.0" step="0.1" value="0.7"></div>
                            <div class="text-xs"><div class="flex justify-between text-[var(--text-secondary)]"><span>Max New Tokens</span><span id="max-new-tokens-value">512</span></div><input id="max-new-tokens" type="range" min="32" max="2048" step="32" value="512"></div>
                            <div class="text-xs"><div class="flex justify-between text-[var(--text-secondary)]"><span>Top-P</span><span id="top-p-value">0.95</span></div><input id="top-p" type="range" min="0.1" max="1.0" step="0.05" value="0.95"></div>
                        </div>
                    </div>
                </div>
            </div>
            <button id="clear-chat" class="w-full mt-4 text-sm bg-red-600/20 hover:bg-red-600/40 text-red-400 font-semibold py-2 rounded-md transition"><i class="fa-regular fa-trash-can mr-2"></i>대화 초기화</button>
        </aside>

        <!-- Main Chat Area -->
        <main class="w-full h-full flex flex-col bg-[var(--chat-bg)] rounded-2xl shadow-lg">
             <header class="flex items-center justify-between p-4 flex-shrink-0 bg-[var(--sidebar-bg)] backdrop-blur-sm rounded-t-2xl border-b border-[var(--border)]">
                <button id="sidebar-toggle" class="lg:hidden p-2 text-[var(--text-secondary)]"><i class="fas fa-bars text-xl"></i></button>
                <div class="text-center flex-1 lg:ml-0"><h1 id="chat-header" class="text-lg font-semibold text-[var(--text-primary)]">google/gemma-3-1b-it</h1></div>
                <div class="flex items-center gap-4">
                    <button id="theme-toggle" class="p-2 text-[var(--text-secondary)]"><i class="fas fa-sun text-xl"></i></button>
                    <button id="help-button" class="p-2 text-[var(--text-secondary)]"><i class="fas fa-question-circle text-xl"></i></button>
                </div>
            </header>

            <div id="chat-messages" class="flex-1 overflow-y-auto p-6 space-y-6"></div>

            <div class="p-4 bg-[var(--sidebar-bg)] backdrop-blur-sm rounded-b-2xl">
                <div id="image-preview-container" class="hidden items-center mb-2 bg-[var(--ai-msg-bg)] p-2 rounded-lg">
                    <img id="image-preview" src="" class="w-16 h-16 object-cover rounded-md"><span id="image-name" class="text-sm ml-3 text-[var(--text-secondary)]"></span>
                    <button id="remove-image" class="ml-auto text-[var(--text-secondary)] hover:text-[var(--text-primary)]"><i class="fas fa-times"></i></button>
                </div>
                <form id="chat-form" class="flex items-center gap-4">
                    <label for="file-input" class="cursor-pointer text-[var(--text-secondary)] hover:text-[var(--accent)] transition"><i class="fas fa-paperclip text-xl"></i></label>
                    <input type="file" id="file-input" class="hidden" accept="image/*,text/plain">
                    <textarea id="user-input" placeholder="메시지를 입력하거나 파일을 첨부하세요..." rows="1" class="flex-1 bg-[var(--ai-msg-bg)] border border-[var(--border)] rounded-xl px-4 py-3 text-base text-[var(--text-primary)] resize-none focus:ring-2 focus:ring-[var(--accent)] focus:outline-none transition"></textarea>
                    <button type="submit" class="bg-[var(--accent)] h-12 w-12 rounded-full text-white font-semibold flex items-center justify-center flex-shrink-0 hover:opacity-80 transition"><i class="fas fa-arrow-up"></i></button>
                </form>
            </div>
        </main>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div id="modal-backdrop" class="modal-backdrop absolute inset-0"></div>
        <div class="relative w-full max-w-2xl bg-[var(--sidebar-bg)] border border-[var(--border)] rounded-lg shadow-xl p-8 m-4">
            <h2 class="text-2xl font-bold text-[var(--text-primary)] mb-4">AI 챗봇은 어떻게 작동할까요?</h2>
            <div class="text-[var(--text-secondary)] space-y-4 text-sm max-h-[70vh] overflow-y-auto pr-4">
                <p>이 챗봇은 Hugging Face의 Inference API를 사용하여 웹 브라우저에서 직접 AI 모델과 대화하는 경험을 제공합니다. 모든 것은 여러분의 브라우저와 Hugging Face 서버 간의 통신으로 이루어집니다.</p>
                <div><h3 class="font-semibold text-[var(--accent)] mb-1">1. API (Application Programming Interface)</h3><p>API는 식당의 '웨이터'와 같습니다. 여러분(클라이언트)이 주문(요청)을 하면, 웨이터는 주방(서버)에 주문을 전달하고, 완성된 요리(응답)를 다시 여러분에게 가져다줍니다. 이 챗봇에서는 여러분의 메시지가 '요청'이 되어 Hugging Face의 AI 모델이라는 '서버'로 전송되고, AI의 답변이 '응답'으로 돌아옵니다.</p></div>
                <div><h3 class="font-semibold text-[var(--accent)] mb-1">2. 모델 (Model)</h3><p>AI 모델은 특정 작업을 수행하도록 훈련된 거대한 디지털 두뇌입니다. 이 챗봇에서는 다양한 종류의 모델을 사용할 수 있습니다.</p><ul class="list-disc list-inside space-y-1 mt-2"><li><strong>텍스트 생성:</strong> 질문에 답하거나, 글을 쓰거나, 코드를 짜는 등 텍스트 기반의 작업을 수행합니다. (예: <code class="bg-[var(--ai-msg-bg)] text-xs p-1 rounded">gemma-3-1b-it</code>)</li><li><strong>이미지 생성:</strong> 텍스트 설명으로 완전히 새로운 이미지를 만들어냅니다. (예: <code class="bg-[var(--ai-msg-bg)] text-xs p-1 rounded">stabilityai/stable-diffusion-2</code>)</li><li><strong>이미지 설명:</strong> 이미지를 보고 그 내용을 텍스트로 설명합니다. (예: <code class="bg-[var(--ai-msg-bg)] text-xs p-1 rounded">Salesforce/blip-image-captioning-large</code>)</li></ul></div>
                <div><h3 class="font-semibold text-[var(--accent)] mb-1">3. 파라미터 튜닝</h3><p>AI 모델의 답변 스타일을 미세하게 조절하는 기능입니다.</p><ul class="list-disc list-inside space-y-1 mt-2"><li><strong>Temperature:</strong> '창의성' 조절기입니다. 값이 높을수록 AI는 더 다양하고 예상치 못한 답변을 하고, 낮을수록 정해진 패턴의 정확한 답변을 합니다.</li><li><strong>Max New Tokens:</strong> AI가 생성할 수 있는 답변의 최대 길이를 제한합니다.</li><li><strong>Top-P:</strong> 답변을 생성할 때, 확률적으로 가능한 단어 후보군을 제한합니다. Temperature와 함께 답변의 다양성을 조절하는 데 사용됩니다.</li></ul></div>
                <div><h3 class="font-semibold text-[var(--accent)] mb-1">4. 채팅 기록 저장</h3><p>모든 대화는 여러분의 웹 브라우저 내의 'localStorage'라는 안전한 공간에 저장됩니다. 이 정보는 외부로 전송되지 않으며, 페이지를 새로고침해도 대화 기록을 이어서 볼 수 있게 해줍니다.</p></div>
            </div>
            <button id="close-modal" class="absolute top-4 right-4 text-[var(--text-secondary)] hover:text-[var(--text-primary)]"><i class="fas fa-times text-2xl"></i></button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const chatHeader = document.getElementById('chat-header');
            const chatMessages = document.getElementById('chat-messages');
            const chatForm = document.getElementById('chat-form');
            const userInput = document.getElementById('user-input');
            const apiKeyInput = document.getElementById('api-key');
            const modelTaskSelect = document.getElementById('model-task');
            const modelIdInput = document.getElementById('model-id');
            const systemPromptInput = document.getElementById('system-prompt');
            const tempSlider = document.getElementById('temperature');
            const tokensSlider = document.getElementById('max-new-tokens');
            const topPSlider = document.getElementById('top-p');
            const tempValue = document.getElementById('temperature-value');
            const tokensValue = document.getElementById('max-new-tokens-value');
            const topPValue = document.getElementById('top-p-value');
            const fileInput = document.getElementById('file-input');
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const imagePreview = document.getElementById('image-preview');
            const imageName = document.getElementById('image-name');
            const removeImageBtn = document.getElementById('remove-image');
            const clearChatBtn = document.getElementById('clear-chat');
            const helpButton = document.getElementById('help-button');
            const helpModal = document.getElementById('help-modal');
            const closeModal = document.getElementById('close-modal');
            const modalBackdrop = document.getElementById('modal-backdrop');
            const themeToggle = document.getElementById('theme-toggle');

            // --- State ---
            let chatHistory = [];
            let attachedFile = null;

            // --- Theme Management ---
            const applyTheme = (theme) => {
                const icon = themeToggle.querySelector('i');
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                } else {
                    document.documentElement.classList.remove('dark');
                    icon.classList.remove('fa-sun');
                    icon.classList.add('fa-moon');
                }
            };
            themeToggle.addEventListener('click', () => {
                const isDark = document.documentElement.classList.toggle('dark');
                const newTheme = isDark ? 'dark' : 'light';
                applyTheme(newTheme);
                localStorage.setItem('ai-playground-theme', newTheme);
            });


            // --- Utility Functions ---
            const fileToBinary = file => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsArrayBuffer(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });

            // --- LocalStorage ---
            const saveState = () => {
                const state = {
                    apiKey: apiKeyInput.value,
                    modelTask: modelTaskSelect.value,
                    modelId: modelIdInput.value,
                    systemPrompt: systemPromptInput.value,
                    temperature: tempSlider.value,
                    maxNewTokens: tokensSlider.value,
                    topP: topPSlider.value,
                    chatHistory: chatHistory
                };
                localStorage.setItem('aiPlaygroundState', JSON.stringify(state));
            };

            const loadState = () => {
                const savedTheme = localStorage.getItem('ai-playground-theme') || 'dark';
                applyTheme(savedTheme);

                const state = JSON.parse(localStorage.getItem('aiPlaygroundState'));
                if (state) {
                    apiKeyInput.value = state.apiKey || '';
                    modelTaskSelect.value = state.modelTask || 'text-generation';
                    modelIdInput.value = state.modelId || 'google/gemma-3-1b-it';
                    systemPromptInput.value = state.systemPrompt || '';
                    tempSlider.value = state.temperature || 0.7;
                    tokensSlider.value = state.maxNewTokens || 512;
                    topPSlider.value = state.topP || 0.95;
                    chatHistory = state.chatHistory || [];
                    updateUIFromState();
                    renderChatHistory();
                }
            };
            
            const updateUIFromState = () => {
                chatHeader.textContent = modelIdInput.value;
                if (tempValue) tempValue.textContent = tempSlider.value;
                if (tokensValue) tokensValue.textContent = tokensSlider.value;
                if (topPValue) topPValue.textContent = topPSlider.value;
            };

            // --- Chat Rendering ---
            const addMessageToUI = (sender, message, isImage = false) => {
                const messageEl = document.createElement('div');
                messageEl.className = `chat-bubble flex items-start gap-4 max-w-xl ${sender === 'user' ? 'self-end flex-row-reverse' : 'self-start'}`;
                
                let avatarClass;
                let avatarIcon;
                let textColor = 'text-white';
                if (sender === 'user') {
                    avatarClass = 'bg-[var(--user-msg-bg)]';
                    avatarIcon = '<i class="fas fa-user"></i>';
                } else {
                    avatarClass = 'bg-[var(--ai-msg-bg)]';
                    avatarIcon = '<i class="fas fa-robot"></i>';
                    textColor = 'text-[var(--text-primary)]';
                }
                const avatar = `<div class="w-8 h-8 rounded-full ${avatarClass} flex items-center justify-center font-bold text-sm flex-shrink-0 text-white">${avatarIcon}</div>`;

                let content;
                if (isImage) {
                    content = `<div class="bg-[var(--ai-msg-bg)] rounded-lg p-2"><img src="${message}" class="max-w-xs rounded-md" /></div>`;
                } else if (sender === 'loading') {
                     content = `<div class="bg-[var(--ai-msg-bg)] rounded-lg px-4 py-3"><div class="spinner w-6 h-6 border-2 border-transparent rounded-full"></div></div>`;
                }
                else {
                    const msgBg = sender === 'user' ? 'bg-[var(--user-msg-bg)]' : 'bg-[var(--ai-msg-bg)]';
                    content = `<div class="${msgBg} rounded-lg px-4 py-3 ${textColor}"><p>${message.replace(/\n/g, '<br>')}</p></div>`;
                }

                messageEl.innerHTML = avatar + content;
                chatMessages.appendChild(messageEl);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                return messageEl;
            };
            
            const renderChatHistory = () => {
                chatMessages.innerHTML = '';
                chatHistory.forEach(msg => addMessageToUI(msg.role, msg.content, msg.isImage));
            };

            // --- API Call ---
            const callHuggingFaceApi = async () => {
                // ... (API call logic remains the same)
                const apiKey = apiKeyInput.value;
                if (!apiKey) {
                    addMessageToUI('ai', 'Hugging Face API 키를 입력해주세요.');
                    return;
                }

                const loadingBubble = addMessageToUI('loading', '');
                
                try {
                    const task = modelTaskSelect.value;
                    const model = modelIdInput.value;
                    const API_URL = `https://api-inference.huggingface.co/models/${model}`;
                    
                    let payload, headers;
                    
                    headers = { "Authorization": `Bearer ${apiKey}` };

                    if (task === 'text-generation') {
                        headers["Content-Type"] = "application/json";
                        let fullPrompt = "";
                        if (systemPromptInput.value) {
                            fullPrompt += `<|system|>\n${systemPromptInput.value}\n`;
                        }
                        chatHistory.forEach(msg => {
                             if(msg.role === 'user' || msg.role === 'assistant') {
                                fullPrompt += `<|${msg.role}|>\n${msg.content}\n`;
                            }
                        });
                        fullPrompt += "<|assistant|>\n";

                        payload = {
                            inputs: fullPrompt,
                            parameters: {
                                temperature: parseFloat(tempSlider.value),
                                max_new_tokens: parseInt(tokensSlider.value),
                                top_p: parseFloat(topPSlider.value),
                                return_full_text: false,
                            }
                        };
                         const response = await fetch(API_URL, { method: 'POST', headers, body: JSON.stringify(payload) });
                         const result = await response.json();
                         if (response.ok) {
                             const aiResponse = result[0].generated_text.trim();
                             chatHistory.push({ role: 'assistant', content: aiResponse });
                             addMessageToUI('ai', aiResponse);
                         } else {
                             throw new Error(result.error || "Unknown error");
                         }
                    } else if (task === 'text-to-image') {
                        headers["Content-Type"] = "application/json";
                        const lastUserMessage = chatHistory.slice().reverse().find(m => m.role === 'user').content;
                        payload = { inputs: lastUserMessage };
                         const response = await fetch(API_URL, { method: 'POST', headers, body: JSON.stringify(payload) });
                         if (response.ok) {
                             const imageBlob = await response.blob();
                             const imageUrl = URL.createObjectURL(imageBlob);
                             chatHistory.push({ role: 'assistant', content: imageUrl, isImage: true });
                             addMessageToUI('ai', imageUrl, true);
                         } else {
                            const result = await response.json();
                             throw new Error(result.error);
                         }
                    } else if (task === 'image-to-text') {
                        if (!attachedFile) throw new Error("이미지를 첨부해주세요.");
                        const binaryData = await fileToBinary(attachedFile);
                        const response = await fetch(API_URL, { method: 'POST', headers, body: binaryData });
                        const result = await response.json();
                        if (response.ok) {
                            const caption = result[0].generated_text;
                            chatHistory.push({ role: 'assistant', content: caption });
                            addMessageToUI('ai', caption);
                        } else {
                             throw new Error(result.error);
                        }
                    }
                } catch (error) {
                    addMessageToUI('ai', `오류가 발생했습니다: ${error.message}`);
                } finally {
                    loadingBubble.remove();
                    saveState();
                }
            };

            // --- Event Listeners ---
            const toggleSidebar = () => {
                sidebar.classList.toggle('-translate-x-[calc(100%+1rem)]');
                sidebarOverlay.classList.toggle('hidden');
            };
            
            sidebarToggle.addEventListener('click', toggleSidebar);
            sidebarOverlay.addEventListener('click', toggleSidebar);

            [apiKeyInput, modelIdInput, systemPromptInput, modelTaskSelect].forEach(el => {
                el.addEventListener('change', saveState);
            });
            
            modelIdInput.addEventListener('change', (e) => chatHeader.textContent = e.target.value);

            [tempSlider, tokensSlider, topPSlider].forEach(slider => {
                slider.addEventListener('input', (e) => {
                    const valueEl = document.getElementById(`${e.target.id}-value`);
                    if (valueEl) valueEl.textContent = e.target.value;
                });
                slider.addEventListener('change', saveState);
            });
            
            chatForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const text = userInput.value.trim();
                
                if (text === '' && !attachedFile) return;

                let userMessageContent = text;
                if (attachedFile) {
                    const fileText = `[파일: ${attachedFile.name}]`;
                    userMessageContent = text ? `${fileText}\n${text}` : fileText;
                }
                
                addMessageToUI('user', userMessageContent);
                chatHistory.push({ role: 'user', content: text });
                
                callHuggingFaceApi();
                
                userInput.value = '';
                userInput.style.height = 'auto';
                if (attachedFile) {
                    attachedFile = null;
                    imagePreviewContainer.classList.add('hidden');
                }
            });

            userInput.addEventListener('input', () => {
                userInput.style.height = 'auto';
                userInput.style.height = `${userInput.scrollHeight}px`;
            });
            
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    attachedFile = file;
                    imagePreview.src = URL.createObjectURL(file);
                    imageName.textContent = file.name;
                    imagePreviewContainer.classList.remove('hidden');
                }
            });

            removeImageBtn.addEventListener('click', () => {
                attachedFile = null;
                fileInput.value = '';
                imagePreviewContainer.classList.add('hidden');
            });
            
            clearChatBtn.addEventListener('click', () => {
                if(confirm('모든 대화 기록과 설정을 초기화하시겠습니까?')) {
                    localStorage.removeItem('aiPlaygroundState');
                    chatHistory = [];
                    renderChatHistory();
                    location.reload();
                }
            });

            helpButton.addEventListener('click', () => helpModal.classList.remove('hidden'));
            closeModal.addEventListener('click', () => helpModal.classList.add('hidden'));
            modalBackdrop.addEventListener('click', () => helpModal.classList.add('hidden'));
            
            // --- Init ---
            loadState();
        });
    </script>
</body>
</html>

