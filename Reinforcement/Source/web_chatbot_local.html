<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local AI Web Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #111827;
            --chat-bg: #1F2937;
            --user-bubble: #4338CA;
            --ai-bubble: #374151;
            --text-main: #F9FAFB;
            --text-secondary: #9CA3AF;
            --accent: #EF4444;
        }
        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            background-color: var(--bg-color);
        }
        .chat-bubble {
            opacity: 0;
            transform: translateY(20px);
            animation: popIn 0.3s ease-out forwards;
        }
        @keyframes popIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .thinking-bubble {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .thinking-bubble span {
            width: 8px;
            height: 8px;
            background-color: var(--text-secondary);
            border-radius: 50%;
            animation: bounce 1s infinite;
        }
        .thinking-bubble span:nth-child(2) { animation-delay: 0.2s; }
        .thinking-bubble span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-6px); }
        }
        /* Custom scrollbar */
        #chat-container::-webkit-scrollbar { width: 6px; }
        #chat-container::-webkit-scrollbar-track { background: var(--chat-bg); }
        #chat-container::-webkit-scrollbar-thumb { background-color: var(--accent); border-radius: 20px; }
    </style>
</head>
<body class="flex flex-col items-center justify-center h-screen bg-gray-900 text-gray-100 p-4">

    <div class="w-full max-w-2xl h-full flex flex-col bg-gray-800 rounded-2xl shadow-2xl border border-gray-700">
        <header class="p-4 border-b border-gray-700 text-center">
            <h1 class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-red-400 to-orange-500">Local AI Chatbot</h1>
            <p id="status" class="text-xs text-gray-400 mt-1">Python 서버에 연결을 시도합니다...</p>
        </header>

        <main id="chat-container" class="flex-1 p-4 overflow-y-auto space-y-4">
            <!-- Chat messages will be appended here -->
             <div class="chat-bubble flex items-start gap-3 justify-start">
                <div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center font-bold text-sm flex-shrink-0">AI</div>
                <div class="bg-gray-700 rounded-lg p-3 max-w-xs md:max-w-md">
                    <p class="text-sm">안녕하세요! 로컬 AI 서버에 연결되었습니다. 무엇이든 물어보세요.</p>
                </div>
            </div>
        </main>

        <footer class="p-4 border-t border-gray-700">
            <form id="chat-form" class="flex items-center gap-2">
                <input type="text" id="user-input" placeholder="메시지를 입력하세요..." class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-sm text-gray-200 focus:ring-2 focus:ring-red-500 focus:outline-none transition" disabled>
                <button type="submit" id="send-button" class="bg-red-600 hover:bg-red-700 text-white font-semibold px-4 py-2 rounded-lg text-sm transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-send-fill" viewBox="0 0 16 16">
                        <path d="M15.964.686a.5.5 0 0 0-.65-.65L.767 5.855H.766l-.452.18a.5.5 0 0 0-.082.887l.41.26.001.002 4.995 3.178 3.178 4.995.002.002.26.41a.5.5 0 0 0 .886-.083l6-15Zm-1.833 1.89L6.637 10.07l-.215-.338a.5.5 0 0 0-.154-.154l-.338-.215 7.494-7.494 1.178-.471-.47 1.178Z"/>
                    </svg>
                </button>
            </form>
        </footer>
    </div>
    
    <script>
        const status = document.getElementById('status');
        const chatContainer = document.getElementById('chat-container');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        
        const SERVER_URL = 'http://127.0.0.1:5000/chat';
        let messages = [];

        async function checkServerStatus() {
            try {
                // 서버에 간단한 GET 요청을 보내 상태를 확인 (서버가 응답하는지)
                const response = await fetch('http://127.0.0.1:5000/', { method: 'HEAD', mode: 'no-cors' }).catch(() => {});
                 // 실제로는 CORS 때문에 성공적인 응답을 받기 어려우나, 서버가 켜져있는지 확인용
                status.textContent = 'AI 서버에 연결되었습니다.';
                userInput.disabled = false;
                sendButton.disabled = false;
                userInput.placeholder = "AI에게 메시지 보내기...";
            } catch (error) {
                 status.textContent = 'AI 서버를 찾을 수 없습니다. server.py를 실행했는지 확인하세요.';
            }
        }
        
        // 페이지 로드 시 서버 상태를 주기적으로 확인 (예시)
        // 실제로는 한 번만 확인하거나, 사용자가 버튼을 눌렀을 때 확인
        setTimeout(checkServerStatus, 1000);


        function addMessage(role, content) {
            const isUser = role === 'user';
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble flex items-start gap-3 ${isUser ? 'justify-end' : 'justify-start'}`;
            
            const avatar = `<div class="w-8 h-8 rounded-full ${isUser ? 'bg-indigo-700' : 'bg-gray-600'} flex items-center justify-center font-bold text-sm flex-shrink-0">${isUser ? 'You' : 'AI'}</div>`;
            const messageContent = `<div class="${isUser ? 'bg-indigo-700' : 'bg-gray-700'} rounded-lg p-3 max-w-xs md:max-w-md"><p class="text-sm text-white">${content}</p></div>`;

            bubble.innerHTML = isUser ? messageContent + avatar : avatar + messageContent;
            chatContainer.appendChild(bubble);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function showThinkingIndicator() {
            const thinkingBubble = document.createElement('div');
            thinkingBubble.id = 'thinking-indicator';
            thinkingBubble.className = 'chat-bubble flex items-start gap-3 justify-start';
            thinkingBubble.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center font-bold text-sm flex-shrink-0">AI</div>
                <div class="bg-gray-700 rounded-lg p-3">
                    <div class="thinking-bubble"><span></span><span></span><span></span></div>
                </div>
            `;
            chatContainer.appendChild(thinkingBubble);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function removeThinkingIndicator() {
            const indicator = document.getElementById('thinking-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userText = userInput.value.trim();
            if (userText === '') return;

            addMessage('user', userText);
            userInput.value = '';
            sendButton.disabled = true;
            showThinkingIndicator();

            messages.push({ role: 'user', content: userText });

            try {
                const response = await fetch(SERVER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages: messages })
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.statusText}`);
                }

                const data = await response.json();
                const aiResponse = data.response;
                
                messages.push({ role: 'assistant', content: aiResponse });
                
                removeThinkingIndicator();
                addMessage('assistant', aiResponse);

            } catch (error) {
                removeThinkingIndicator();
                addMessage('assistant', '죄송합니다, AI 서버와 통신하는 데 실패했습니다. 서버가 실행 중인지 확인해주세요.');
                console.error("Fetch error:", error);
            } finally {
                sendButton.disabled = false;
            }
        });
    </script>
</body>
</html>
