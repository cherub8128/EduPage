<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemma 3 채팅 AI 백엔드 만들기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #282c34; color: #abb2bf; }
        .slide { display: none; }
        .slide.active { display: block; }
        .code-highlight { background-color: rgba(255, 255, 0, 0.15); display: block; margin: -0.25rem -0.5rem; padding: 0.25rem 0.5rem; border-radius: 0.25rem; }
        pre[class*="language-"] { font-size: 0.9rem; line-height: 1.6; white-space: pre-wrap; word-break: break-all; }
        .explanation-box { background-color: #21252b; border-left: 4px solid #98c379; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto bg-[#21252b] rounded-xl shadow-2xl overflow-hidden">
        <div class="p-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white text-center">Gemma 3 채팅 AI 백엔드 만들기</h1>
            <p class="text-center text-gray-400 mt-2">웹 UI와 통신하는 파이썬 서버를 구축해봅시다.</p>
        </div>

        <div id="slider-container" class="p-4 md:p-8 border-t border-gray-700 min-h-[500px]"></div>

        <div class="bg-[#282c34] p-4 flex justify-between items-center">
            <button id="prevBtn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">이전</button>
            <div id="slide-counter" class="text-white text-lg font-semibold"></div>
            <button id="nextBtn" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg transition duration-300">다음</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        const slides = [
            {
                title: "1. 아키텍처 이해 및 프론트엔드 준비",
                explanation: `
                    <p>우리는 두 개의 독립적인 프로그램을 만들어 서로 통신하게 할 것입니다.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 text-center">
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <p class="text-2xl">🖥️</p>
                            <p class="font-bold text-white">프론트엔드 (chat.html)</p>
                            <p class="text-sm text-gray-400">사용자에게 보여지는 채팅 UI.</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <p class="text-2xl">🐍</p>
                            <p class="font-bold text-white">백엔드 (app.py)</p>
                            <p class="text-sm text-gray-400">AI 모델을 실행하고 계산을 처리하는 파이썬 서버.</p>
                        </div>
                    </div>
                    <p class="mt-4">먼저, 아래 버튼을 클릭하여 웹 브라우저에 표시될 채팅 UI 파일(<code class="bg-gray-700 p-1 rounded">chat.html</code>)을 다운로드하세요. 이 파일은 우리가 만들 백엔드 서버와 통신하도록 미리 설정되어 있습니다.</p>
                     <div class="mt-4">
                        <a href="chat.html" download="chat.html" class="inline-block bg-teal-500 hover:bg-teal-400 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                            chat.html 다운로드
                        </a>
                    </div>
                `,
                code: ``
            },
            {
                title: "2. 백엔드 서버 준비하기 (Flask)",
                explanation: `
                    <p>파이썬으로 웹 서버를 쉽게 만들 수 있도록 도와주는 <strong>Flask</strong>라는 도구를 사용할 겁니다. 프론트엔드(HTML)와 백엔드(Python)가 서로 다른 곳에서 실행되므로, 보안 정책(CORS)을 허용해주는 도구도 함께 설치합니다.</p>
                `,
                code: `
# 터미널에 아래 명령어를 입력하여 필요한 라이브러리를 설치합니다.
# transformers, torch는 이전에 설치했다고 가정합니다.
<span class="code-highlight">pip install Flask Flask-Cors</span>
                `
            },
            {
                title: "3. Gemma 모델 로드 및 Flask 서버 설정",
                explanation: `
                    <p>이제 백엔드 파이썬 스크립트(<code class="bg-gray-700 p-1 rounded">app.py</code>)를 작성합니다. 가장 먼저, 필요한 라이브러리를 import하고 Gemma 모델을 로드합니다.</p>
                    <p class="mt-2"><strong>중요:</strong> 모델 로딩은 시간이 오래 걸리므로, 서버가 처음 시작될 때 딱 한 번만 실행되도록 코드의 맨 위에 배치합니다.</p>
                `,
                code: `
# app.py
from flask import Flask, request, jsonify
from flask_cors import CORS
import torch
from transformers import pipeline

print("Loading Gemma 3 270M model...")
device = "cuda" if torch.cuda.is_available() else "cpu"
pipe = pipeline(
    "text-generation",
    model="google/gemma-3-270m-it",
    model_kwargs={"torch_dtype": torch.bfloat16},
    device=device,
)
print(f"Model loaded on {device}!")

<span class="code-highlight">app = Flask(__name__)</span>
<span class="code-highlight">CORS(app) # 모든 외부 요청을 허용</span>
                `
            },
            {
                title: "4. API 엔드포인트 만들기",
                explanation: `
                    <p>프론트엔드가 메시지를 보낼 '창구'를 만들어야 합니다. 이것을 <strong>API 엔드포인트</strong>라고 부릅니다.</p>
                    <p class="mt-2"><code class="bg-gray-700 p-1 rounded">@app.route('/chat', methods=['POST'])</code>는 "누군가 우리 서버의 /chat 주소로 POST 방식의 요청을 보내면, 바로 아래 함수를 실행해!" 라는 의미의 약속입니다.</p>
                `,
                code: `
# ... (이전 코드) ...
app = Flask(__name__)
CORS(app)

<span class="code-highlight">@app.route('/chat', methods=['POST'])</span>
<span class="code-highlight">def chat():</span>
<span class="code-highlight">    # 프론트엔드에서 보낸 대화 기록(JSON)을 받습니다.</span>
<span class="code-highlight">    data = request.json</span>
<span class="code-highlight">    messages = data.get('messages')</span>
<span class="code-highlight"></span>
<span class="code-highlight">    if not messages:</span>
<span class="code-highlight">        return jsonify({"error": "No messages provided"}), 400</span>
<span class="code-highlight"></span>
<span class="code-highlight">    # Gemma 모델로 답변 생성 (다음 슬라이드에서 계속)</span>
<span class="code-highlight">    # ...</span>
                `
            },
            {
                title: "5. Gemma 답변 생성 및 반환",
                explanation: `
                    <p>프론트엔드에서 받은 대화 기록을 Gemma 파이프라인에 전달하여 AI의 답변을 생성합니다.</p>
                    <p class="mt-2">생성된 답변은 다시 JSON 형태로 프론트엔드에 돌려줍니다. 프론트엔드는 이 JSON을 받아 화면에 표시하게 됩니다.</p>
                `,
                code: `
@app.route('/chat', methods=['POST'])
def chat():
    data = request.json
    messages = data.get('messages')
    
    # Hugging Face 파이프라인 형식에 맞게 'role'과 'content'를 맞춰줍니다.
    hf_messages = [{"role": msg["role"], "content": msg["content"]} for msg in messages]

<span class="code-highlight">    outputs = pipe(hf_messages, max_new_tokens=512, do_sample=True)</span>
<span class="code-highlight">    assistant_response = outputs[0][-1]["content"]</span>
<span class="code-highlight">    </span>
<span class="code-highlight">    # 생성된 답변을 JSON 형식으로 프론트엔드에 응답합니다.</span>
<span class="code-highlight">    return jsonify({"response": assistant_response})</span>
                `
            },
            {
                title: "6. 완성된 백엔드 스크립트",
                explanation: `
                    <p>모든 조각을 합치면 아래와 같은 완전한 백엔드 서버 코드가 됩니다. 이 코드를 <code class="bg-gray-700 p-1 rounded">app.py</code>로 저장하세요.</p>
                `,
                code: `
# app.py
from flask import Flask, request, jsonify
from flask_cors import CORS
import torch
from transformers import pipeline

# 1. 모델 로딩 (서버 시작 시 한 번만)
print("Loading Gemma 3 270M model...")
device = "cuda" if torch.cuda.is_available() else "cpu"
pipe = pipeline(
    "text-generation",
    model="google/gemma-3-270m-it",
    model_kwargs={"torch_dtype": torch.bfloat16},
    device=device,
)
print(f"Model loaded on {device}!")

# 2. Flask 앱 설정
app = Flask(__name__)
CORS(app)

# 3. API 엔드포인트 정의
@app.route('/chat', methods=['POST'])
def chat():
    data = request.json
    messages = data.get('messages')

    if not messages:
        return jsonify({"error": "No messages provided"}), 400
    
    hf_messages = [{"role": msg["role"], "content": msg["content"]} for msg in messages]
    
    outputs = pipe(hf_messages, max_new_tokens=512, do_sample=True)
    assistant_response = outputs[0][-1]["content"]
    
    return jsonify({"response": assistant_response})

# 4. 서버 실행
if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)
                `
            },
            {
                title: "7. 실행하고 즐기기!",
                explanation: `
                    <p>이제 모든 준비가 끝났습니다. 아래 순서대로 실행하여 나만의 AI 채팅 앱을 즐겨보세요!</p>
                    <div class="explanation-box">
                        <p><strong>실행 순서:</strong><br>
                        1. 터미널을 열고 <code class="bg-gray-700 p-1 rounded">app.py</code>와 <code class="bg-gray-700 p-1 rounded">chat.html</code>을 같은 폴더에 저장합니다.<br>
                        2. 터미널에서 <code class="bg-gray-700 p-1 rounded">python app.py</code>를 입력하여 <strong>백엔드 서버를 먼저 실행</strong>합니다.<br>
                        3. 서버가 실행되면, <code class="bg-gray-700 p-1 rounded">chat.html</code> 파일을 웹 브라우저에서 엽니다.<br>
                        4. 이제 채팅창에 메시지를 입력하고 AI와 대화할 수 있습니다!
                        </p>
                    </div>
                `,
                code: ``
            }
        ];

        let currentSlide = 0;
        const sliderContainer = document.getElementById('slider-container');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const slideCounter = document.getElementById('slide-counter');

        function createSlide(slideData, index) {
            const slideElement = document.createElement('div');
            slideElement.className = 'slide p-4';
            slideElement.dataset.index = index;

            let codeHtml = '';
            if (slideData.code) {
                const tempDiv = document.createElement('div');
                const codeWithPlaceholders = slideData.code.trim()
                    .replace(/<span class="code-highlight">/g, '[[HIGHLIGHT_START]]')
                    .replace(/<\/span>/g, '[[HIGHLIGHT_END]]');
                tempDiv.textContent = codeWithPlaceholders;
                const finalCode = tempDiv.innerHTML
                    .replace(/\[\[HIGHLIGHT_START\]\]/g, '<span class="code-highlight">')
                    .replace(/\[\[HIGHLIGHT_END\]\]/g, '</span>');
                codeHtml = `<div class="mt-6 bg-[#282c34] rounded-lg overflow-hidden border border-gray-700"><pre class="language-python !text-sm !leading-relaxed"><code>${finalCode}</code></pre></div>`;
            }

            slideElement.innerHTML = `<div class="grid grid-cols-1 ${slideData.code ? 'md:grid-cols-2' : ''} gap-8 items-start"><div class="prose prose-invert max-w-none"><h2 class="text-2xl font-bold text-indigo-400 mb-4">${slideData.title}</h2><div class="text-gray-300 leading-relaxed space-y-2">${slideData.explanation}</div></div>${slideData.code ? `<div>${codeHtml}</div>` : ''}</div>`;
            return slideElement;
        }

        function updateSlider() {
            document.querySelectorAll('.slide').forEach((slide, index) => {
                slide.classList.toggle('active', index === currentSlide);
            });
            slideCounter.textContent = `${currentSlide + 1} / ${slides.length}`;
            prevBtn.disabled = currentSlide === 0;
            nextBtn.disabled = currentSlide === slides.length - 1;
            Prism.highlightAll();
        }

        prevBtn.addEventListener('click', () => { if (currentSlide > 0) { currentSlide--; updateSlider(); } });
        nextBtn.addEventListener('click', () => { if (currentSlide < slides.length - 1) { currentSlide++; updateSlider(); } });
        
        slides.forEach((slideData, index) => { sliderContainer.appendChild(createSlide(slideData, index)); });
        updateSlider();
    </script>
</body>
</html>
