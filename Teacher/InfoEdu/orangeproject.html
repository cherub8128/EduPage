<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orange3 데이터 분석 보고서</title>
    
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; }
        .editable-container .prose { cursor: text; min-height: 80px; padding: 0.75rem; border-radius: 0.375rem; border: 1px solid transparent; transition: background-color 0.2s; }
        .editable-container .prose:hover { background-color: #f8fafc; border-color: #e2e8f0; }
        
        /* Orange Theme */
        .theme-orange { color: #f97316; }
        .bg-orange-600 { background-color: #ea580c; }
        .hover\:bg-orange-700:hover { background-color: #c2410c; }
        .border-orange-500 { border-color: #f97316; }
        .focus\:ring-orange-200:focus { --tw-ring-color: #fed7aa; }
        .ring-orange-500 { --tw-ring-color: #f97316; }
        .border-orange-500 { border-color: #f97316; }
        .report-section h3, 
        .report-section .editable-container, 
        .report-section .screenshot-wrapper {
            break-inside: avoid; /* 페이지 나눔 방지 */
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <main class="max-w-4xl mx-auto">
        <header class="text-center mb-10 no-print">
            <div class="flex justify-center items-center gap-3 mb-4">
                 <div class="w-12 h-12 bg-orange-600 rounded-lg flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-share-2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"/><line x1="15.41" x2="8.59" y1="6.51" y2="10.49"/></svg>
                 </div>
                <h1 class="text-4xl font-extrabold text-slate-800">Orange3 데이터 분석 보고서</h1>
            </div>
            <p class="text-slate-500">각 항목에 내용을 입력하여 보고서를 완성하세요.</p>
        </header>

        <div id="report-content" class="bg-white rounded-lg shadow-md">
            <section class="report-section p-8 break-inside-avoid">
                <div class="space-y-4">
                    <div>
                        <label for="project-title" class="text-lg font-semibold text-slate-700">🚀 프로젝트 제목</label>
                        <input type="text" id="project-title" placeholder="예: 붓꽃(Iris) 품종 분류 모델 개발" class="savable w-full border border-slate-300 rounded-md p-2 mt-2 focus:outline-none focus:ring-2 focus:ring-orange-200">
                    </div>
                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <div>
                            <label for="student-id" class="text-lg font-semibold text-slate-700">🔢 학번</label>
                            <input type="text" id="student-id" placeholder="예: 30101" class="savable w-full border border-slate-300 rounded-md p-2 mt-2 focus:outline-none focus:ring-2 focus:ring-orange-200">
                        </div>
                        <div>
                            <label for="student-name" class="text-lg font-semibold text-slate-700">🆎 이름</label>
                            <input type="text" id="student-name" placeholder="예: 홍길동" class="savable w-full border border-slate-300 rounded-md p-2 mt-2 focus:outline-none focus:ring-2 focus:ring-orange-200">
                        </div>
                    </div>
                </div>
            </section>
            
            <section class="report-section p-8 break-inside-avoid">
                <h2 class="text-2xl font-bold text-slate-800 border-b-2 border-orange-500 pb-3 mb-6">제작 동기</h2>
                <div class="editable-container mt-2">
                    <textarea class="savable markdown-input w-full border-slate-300 rounded-md shadow-sm focus:ring-orange-500 focus:border-orange-500 hidden" id="motivation" placeholder="이 프로젝트를 만들게 된 이유를 자신의 진로나 관심사, 보강하고 싶은 교과목과 관련지어 구체적으로 작성해주세요."></textarea>
                    <div class="markdown-preview prose max-w-none"></div>
                </div>
            </section>

            <section class="report-section p-8 break-inside-avoid">
                <h2 class="text-2xl font-bold text-slate-800 border-b-2 border-orange-500 pb-3 mb-6">만들면서 어려웠던 점과 극복 방식</h2>
                <h3 class="text-lg font-semibold mt-4 text-slate-700">😥 만들면서 어려웠던 점</h3>
                <div class="editable-container mt-2">
                    <textarea class="savable markdown-input w-full border-slate-300 rounded-md shadow-sm focus:ring-orange-500 focus:border-orange-500 hidden" id="difficulty" placeholder="데이터 전처리 과정, 적절한 위젯 선택, 모델 성능 해석 등 프로젝트를 진행하며 겪었던 기술적, 개념적 어려움을 구체적으로 서술하세요."></textarea>
                    <div class="markdown-preview prose max-w-none"></div>
                </div>
                <h3 class="text-lg font-semibold mt-6 text-slate-700">💪 극복한 방법</h3>
                 <div class="editable-container mt-2">
                    <textarea class="savable markdown-input w-full border-slate-300 rounded-md shadow-sm focus:ring-orange-500 focus:border-orange-500 hidden" id="solution" placeholder="어려움을 해결하기 위해 참고한 자료(공식 문서, 블로그 등), 시도했던 방법, 그리고 그 과정에서 무엇을 배웠는지 상세히 작성해주세요."></textarea>
                    <div class="markdown-preview prose max-w-none"></div>
                </div>
            </section>

            <section class="report-section p-8 break-inside-avoid">
                <h2 class="text-2xl font-bold text-slate-800 border-b-2 border-orange-500 pb-3 mb-6">프로젝트 사용 개념</h2>
                <h3 class="text-lg font-semibold mt-4 text-slate-700">📊 사용 데이터 설명</h3>
                 <div class="editable-container mt-2">
                    <textarea class="savable markdown-input w-full border-slate-300 rounded-md shadow-sm hidden" id="data-desc" placeholder="사용한 데이터셋의 출처와 주제를 설명하고, 전체 데이터 수, 훈련/테스트 데이터 분할 비율, 사용한 데이터 훈련 방식(예: Cross Validation k=5) 등을 기입하세요."></textarea>
                    <div class="markdown-preview prose max-w-none"></div>
                </div>
                
                <h4 class="text-md font-semibold mt-6 mb-2 text-slate-600">수치 데이터의 경우 (변수 설명)</h4>
                <div class="editable-container mt-2">
                    <textarea class="savable markdown-input w-full border-slate-300 rounded-md shadow-sm hidden" id="data-numeric" placeholder="Target, Feature, Meta, Skip으로 설정한 각 변수들의 이름, 종류(수치형/범주형), 그리고 데이터 내에서의 의미를 설명합니다."></textarea>
                    <div class="markdown-preview prose max-w-none"></div>
                </div>

                <h4 class="text-md font-semibold mt-6 mb-2 text-slate-600">사진 분류 데이터 경우 (카테고리 예시)</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                    <div>
                        <input type="text" id="category1-name" class="savable w-full border border-slate-300 rounded-md p-2 mb-2 focus:outline-none focus:ring-2 focus:ring-orange-200" placeholder="카테고리 1 이름 (예: 강아지)">
                        <div class="screenshot-wrapper"><label for="screenshot-input-1" class="flex flex-col items-center justify-center w-full min-h-48 border-2 border-slate-300 border-dashed rounded-lg cursor-pointer bg-slate-50 hover:bg-slate-100"><img id="screenshot-preview-1" class="hidden w-full h-full object-contain rounded-lg"><div id="screenshot-placeholder-1" class="text-center text-slate-500 p-4"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-2 text-slate-400"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>이미지 첨부</div></label><input type="file" accept="image/*" class="hidden" id="screenshot-input-1"></div>
                    </div>
                    <div>
                        <input type="text" id="category2-name" class="savable w-full border border-slate-300 rounded-md p-2 mb-2 focus:outline-none focus:ring-2 focus:ring-orange-200" placeholder="카테고리 2 이름 (예: 고양이)">
                        <div class="screenshot-wrapper"><label for="screenshot-input-2" class="flex flex-col items-center justify-center w-full min-h-48 border-2 border-slate-300 border-dashed rounded-lg cursor-pointer bg-slate-50 hover:bg-slate-100"><img id="screenshot-preview-2" class="hidden w-full h-full object-contain rounded-lg"><div id="screenshot-placeholder-2" class="text-center text-slate-500 p-4"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-2 text-slate-400"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>이미지 첨부</div></label><input type="file" accept="image/*" class="hidden" id="screenshot-input-2"></div>
                    </div>
                </div>

                <h3 class="text-lg font-semibold mt-6 text-slate-700">⚙️ Orange3 워크플로우</h3>
                <div class="mt-4 screenshot-wrapper">
                    <label for="screenshot-input-3" class="flex flex-col items-center justify-center w-full min-h-48 border-2 border-slate-300 border-dashed rounded-lg cursor-pointer bg-slate-50 hover:bg-slate-100">
                        <img id="screenshot-preview-3" class="hidden w-full h-full object-contain rounded-lg">
                        <div id="screenshot-placeholder-3" class="text-center text-slate-500 p-4">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-2 text-slate-400"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                            워크플로우 스크린샷 첨부
                        </div>
                    </label>
                    <input type="file" accept="image/*" class="hidden" id="screenshot-input-3">
                </div>
                <div class="editable-container mt-2">
                    <textarea class="savable markdown-input w-full border-slate-300 rounded-md shadow-sm hidden" id="workflow-desc" placeholder="업로드한 워크플로우에 대해 간단히 설명해주세요. (데이터의 흐름, 사용된 주요 위젯의 역할 등)"></textarea>
                    <div class="markdown-preview prose max-w-none"></div>
                </div>
            </section>
            
            <section class="report-section p-8 break-inside-avoid">
                 <h2 class="text-2xl font-bold text-slate-800 border-b-2 border-orange-500 pb-3 mb-6">학습 결과 분석</h2>
                 <h3 class="text-lg font-semibold mt-4 text-slate-700">📈 Test & Score / 혼동 행렬</h3>
                 <div class="mt-4 screenshot-wrapper">
                    <label for="screenshot-input-4" class="flex flex-col items-center justify-center w-full min-h-48 border-2 border-slate-300 border-dashed rounded-lg cursor-pointer bg-slate-50 hover:bg-slate-100">
                        <img id="screenshot-preview-4" class="hidden w-full h-full object-contain rounded-lg">
                        <div id="screenshot-placeholder-4" class="text-center text-slate-500 p-4">
                           <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-2 text-slate-400"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                            학습 결과 스크린샷 첨부
                        </div>
                    </label>
                    <input type="file" accept="image/*" class="hidden" id="screenshot-input-4">
                </div>
                 <h3 class="text-lg font-semibold mt-6 text-slate-700">결과 해석</h3>
                 <div class="editable-container mt-2">
                    <textarea class="savable markdown-input w-full border-slate-300 rounded-md shadow-sm hidden" id="evaluation-interpretation" placeholder="업로드한 학습 결과를 바탕으로 모델의 성능을 구체적인 수치와 함께 해석해주세요. 어떤 모델이 가장 우수한 성능을 보였으며, 그 이유는 무엇이라고 생각하는지 서술합니다."></textarea>
                    <div class="markdown-preview prose max-w-none"></div>
                </div>
            </section>
            
            <section class="report-section p-8 break-inside-avoid">
                <h2 class="text-2xl font-bold text-slate-800 border-b-2 border-orange-500 pb-3 mb-6">프로젝트 관련 교과 지식 탐구</h2>
                <h3 class="text-lg font-semibold mt-4 text-slate-700">🔬 사용된 데이터 관련 개념</h3>
                <div class="editable-container mt-2">
                    <textarea class="savable markdown-input w-full border-slate-300 rounded-md shadow-sm hidden" id="knowledge-data" placeholder="데이터가 다루는 주제와 관련된 교과(수학, 과학, 사회 등) 지식을 심화 탐구하여 작성합니다. 예를 들어, '타이타닉 생존자 예측' 데이터라면 당시의 사회 계급 구조, 선박의 구조 등에 대해 탐구할 수 있습니다."></textarea>
                    <div class="markdown-preview prose max-w-none"></div>
                </div>
                <h3 class="text-lg font-semibold mt-8 text-slate-700">⚙️ 사용된 모델 관련 개념</h3>
                <div class="editable-container mt-2">
                    <textarea class="savable markdown-input w-full border-slate-300 rounded-md shadow-sm hidden" id="knowledge-model" placeholder="사용한 머신러닝 모델(예: 로지스틱 회귀, SVM, 결정 트리)의 수학적, 통계적 원리를 탐구하여 작성합니다. 모델이 어떤 원리로 데이터를 학습하고 예측하는지 설명해주세요. 수식을 포함하여 설명하면 더욱 좋습니다. 예: $y = Wx + b$"></textarea>
                    <div class="markdown-preview prose max-w-none"></div>
                </div>
            </section>

            <section class="report-section p-8 break-inside-avoid">
                <h2 class="text-2xl font-bold text-slate-800 border-b-2 border-orange-500 pb-3 mb-6">느낀점</h2>
                <div class="editable-container mt-2">
                    <textarea class="savable markdown-input w-full border-slate-300 rounded-md shadow-sm hidden" id="reflection" placeholder="프로젝트 전반을 통해 새롭게 알게 된 점, 데이터 분석의 중요성, 진로에 대한 생각 변화 등 자신의 성장과 변화를 중심으로 자유롭게 작성하세요."></textarea>
                    <div class="markdown-preview prose max-w-none"></div>
                </div>
            </section>

            <section class="report-section p-8 break-inside-avoid">
                <h2 class="text-2xl font-bold text-slate-800 border-b-2 border-orange-500 pb-3 mb-6">향후 계획</h2>
                <div class="editable-container mt-2">
                    <textarea class="savable markdown-input w-full border-slate-300 rounded-md shadow-sm hidden" id="future-plan" placeholder="이번 프로젝트를 통해 생긴 추가적인 질문이나, 앞으로 더 깊이 연구해보고 싶은 주제에 대해 간단히 작성해주세요. (예: 다른 변수를 추가하여 모델 성능 개선, 더 복잡한 모델 사용 등)"></textarea>
                    <div class="markdown-preview prose max-w-none"></div>
                </div>
            </section>

            <section class="report-section p-8 break-inside-avoid">
                <h2 class="text-2xl font-bold text-slate-800 border-b-2 border-orange-500 pb-3 mb-6">참고 문헌</h2>
                <div class="editable-container mt-2">
                    <textarea class="savable markdown-input w-full border-slate-300 rounded-md shadow-sm hidden" id="references" placeholder="APA 스타일(7판)에 맞춰 참고한 모든 자료의 출처를 기입하세요."></textarea>
                    <div class="markdown-preview prose max-w-none"></div>
                </div>
            </section>
        </div>
        
        <footer class="text-center mt-8 py-6 no-print">
            <div id="validation-message" class="text-red-600 font-semibold mb-4 h-6"></div>
            <button id="export-pdf" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-6 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg flex items-center gap-2 mx-auto">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                보고서 PDF로 저장
            </button>
        </footer>
    </main>

    <div id="autosave-status" class="no-print fixed bottom-6 right-6 flex items-center bg-slate-800 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-500 z-50">
        <svg id="autosave-icon-saving" class="animate-spin h-5 w-5 mr-3 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
        <svg id="autosave-icon-saved" class="h-5 w-5 mr-3 hidden text-green-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
        <span id="autosave-text"></span>
    </div>

    <div id="loader-overlay" class="fixed inset-0 bg-black bg-opacity-60 flex-col items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center">
            <svg class="animate-spin h-10 w-10 theme-orange mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-lg font-semibold text-slate-700">PDF 생성 중...</p>
            <p class="text-sm text-slate-500 mt-1">보고서 내용을 변환하고 있습니다. 잠시만 기다려주세요.</p>
        </div>
    </div>
    
    <script>
        // Self-contained script for this specific report to ensure stability.
        document.addEventListener('DOMContentLoaded', () => {
            
            const config = {
                storageKey: 'orangeProjectData',
                savableSelector: '.savable',
                screenshotCount: 4,
                hasCodeBlock: false
            };
            
            const { storageKey, savableSelector, screenshotCount, hasCodeBlock } = config;
            const converter = new showdown.Converter({ simpleLineBreaks: true, tables: true, strikethrough: true, ghCompatibleHeaderId: true, emoji: true });
            const exportBtn = document.getElementById('export-pdf');
            const autosaveStatusEl = document.getElementById('autosave-status');
            let saveTimer, statusTimer;

            function showSaveStatus(state) {
                if (!autosaveStatusEl) return;
                const textEl = autosaveStatusEl.querySelector('#autosave-text');
                const iconSaving = autosaveStatusEl.querySelector('#autosave-icon-saving');
                const iconSaved = autosaveStatusEl.querySelector('#autosave-icon-saved');
                
                clearTimeout(statusTimer);
                autosaveStatusEl.classList.remove('opacity-0');

                if (state === 'saving') {
                    if(textEl) textEl.textContent = '저장 중...';
                    if(iconSaving) iconSaving.classList.remove('hidden');
                    if(iconSaved) iconSaved.classList.add('hidden');
                } else if (state === 'saved') {
                    if(textEl) textEl.textContent = '모든 변경사항이 저장되었습니다.';
                    if(iconSaving) iconSaving.classList.add('hidden');
                    if(iconSaved) iconSaved.classList.remove('hidden');
                    statusTimer = setTimeout(() => autosaveStatusEl.classList.add('opacity-0'), 2000);
                }
            }

            function updateMarkdownPreview(textareaElement) {
                if (!textareaElement) return;
                const container = textareaElement.closest('.editable-container');
                if (!container) return;
                const preview = container.querySelector('.markdown-preview');
                if (preview) {
                    const placeholder = `<p class="text-slate-400">${textareaElement.placeholder.split('\n')[0]}...</p>`;
                    const html = textareaElement.value ? converter.makeHtml(textareaElement.value) : placeholder;
                    preview.innerHTML = html;
                    if(window.renderMathInElement) {
                        renderMathInElement(preview, { delimiters: [{left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}] });
                    }
                }
            }
            
            function autoResizeTextarea(textarea) {
                textarea.style.height = 'auto';
                textarea.style.height = (textarea.scrollHeight) + 'px';
            }

            function saveContent() {
                clearTimeout(saveTimer);
                showSaveStatus('saving');
                saveTimer = setTimeout(() => {
                    const data = {};
                    document.querySelectorAll(savableSelector).forEach(el => {
                        data[el.id] = el.value;
                    });
                    for (let i = 1; i <= screenshotCount; i++) {
                        const img = document.getElementById(`screenshot-preview-${i}`);
                        if (img && img.src && !img.src.includes('placeholder')) {
                            data[`screenshot-preview-${i}`] = img.src;
                        }
                    }
                    localStorage.setItem(storageKey, JSON.stringify(data));
                    showSaveStatus('saved');
                }, 1000);
            }

            function loadContent() {
                const data = JSON.parse(localStorage.getItem(storageKey));
                const textareas = document.querySelectorAll('.markdown-input');

                if (!data) {
                    textareas.forEach(el => {
                        el.value = '';
                        updateMarkdownPreview(el);
                    });
                    return;
                }

                document.querySelectorAll(savableSelector).forEach(field => {
                    if (data.hasOwnProperty(field.id)) {
                        field.value = data[field.id];
                    }
                });
                
                for (let i = 1; i <= screenshotCount; i++) {
                    if (data[`screenshot-preview-${i}`]) {
                        const preview = document.getElementById(`screenshot-preview-${i}`);
                        const placeholder = document.getElementById(`screenshot-placeholder-${i}`);
                        preview.src = data[`screenshot-preview-${i}`];
                        preview.classList.remove('hidden');
                        if (placeholder) placeholder.classList.add('hidden');
                    }
                }

                textareas.forEach(updateMarkdownPreview);
            }

            async function exportToPdf() {
                const loader = document.getElementById('loader-overlay');
                const reportContent = document.getElementById('report-content');
                const validationMessage = document.getElementById('validation-message');
                let allFilled = true;

                // --- 1. 유효성 검사 (기존과 동일) ---
                if(validationMessage) validationMessage.textContent = '';
                document.querySelectorAll(savableSelector).forEach(el => {
                    el.classList.remove('border-red-400');
                    if (!el.value.trim()) {
                        el.classList.add('border-red-400');
                        allFilled = false;
                    }
                });
                for (let i = 1; i <= screenshotCount; i++) {
                    const img = document.getElementById(`screenshot-preview-${i}`);
                    if (!img) continue;
                    const wrapper = img.closest('.screenshot-wrapper');
                    if (wrapper) {
                         wrapper.classList.remove('border-red-400', 'border-2');
                        if (!img.src || img.src.includes('placeholder')) {
                            wrapper.classList.add('border-red-400', 'border-2', 'rounded-lg');
                            allFilled = false;
                        }
                    }
                }

                if (!allFilled) {
                    if(validationMessage) validationMessage.textContent = '모든 필수 항목을 작성하고 스크린샷을 첨부해주세요.';
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    return;
                }
                
                if(loader) loader.style.display = 'flex';

                // --- 2. pdf.html()을 사용한 PDF 생성 로직 ---
                try {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: 'a4'
                    });

                    // --- 3. 렌더링을 위해 DOM 준비 ---
                    // 편집창(textarea)을 숨기고 미리보기(preview)를 강제로 표시
                    const editors = reportContent.querySelectorAll('.editable-container textarea');
                    const previews = reportContent.querySelectorAll('.editable-container .markdown-preview, .editable-container pre');
                    
                    editors.forEach(el => el.style.display = 'none');
                    previews.forEach(el => el.style.display = 'block');

                    // KaTeX 수학 공식 다시 렌더링
                    if (window.renderMathInElement) {
                        renderMathInElement(reportContent, {
                            delimiters: [
                                { left: '$$', right: '$$', display: true },
                                { left: '$', right: '$', display: false }
                            ]
                        });
                    }
                    // highlight.js 코드 하이라이팅 다시 적용
                    reportContent.querySelectorAll('pre code').forEach(el => {
                        delete el.dataset.highlighted; // 하이라이트 강제 초기화
                        if(typeof hljs !== 'undefined') hljs.highlightElement(el);
                    });
                    
                    // --- 4. pdf.html() 실행 ---
                    // 이 함수는 DOM을 분석하여 텍스트는 텍스트로, 이미지는 이미지로 변환합니다.
                    await pdf.html(reportContent, {
                        callback: function (doc) {
                            // --- 5. PDF 저장 ---
                            const studentId = document.getElementById('student-id').value.trim() || '학번';
                            const studentName = document.getElementById('student-name').value.trim() || '이름';
                            const docTitle = document.title.split(' ')[0] || '보고서';
                            const filename = `${docTitle}_${studentId}_${studentName}.pdf`;
                            doc.save(filename);

                            // --- 6. 페이지 원상 복구 ---
                            // 렌더링을 위해 추가했던 임시 스타일을 제거하여 원래 상태로 되돌립니다.
                            editors.forEach(el => el.style.display = '');
                            previews.forEach(el => el.style.display = '');
                        },
                        margin: [15, 15, 15, 15], // [top, right, bottom, left]
                        // 'text' 옵션은 CSS의 'break-inside: avoid' 규칙을 존중합니다.
                        autoPaging: 'text', 
                        width: pdf.internal.pageSize.getWidth() - 30, 
                        windowWidth: reportContent.scrollWidth, 
                        html2canvas: {
                            scale: 2, 
                            useCORS: true,
                            logging: false
                        }
                    });

                } catch(error) {
                    console.error("PDF generation error:", error);
                    alert("PDF를 생성하는 데 실패했습니다. 콘솔을 확인해주세요.");
                    
                    // --- 7. 에러 발생 시에도 페이지 원상 복구 ---
                    reportContent.querySelectorAll('.editable-container textarea').forEach(el => el.style.display = '');
                    reportContent.querySelectorAll('.editable-container .markdown-preview, .editable-container pre').forEach(el => el.style.display = '');
                    
                } finally {
                    if(loader) loader.style.display = 'none';
                }
            }

            function initialize() {
                document.querySelectorAll('.editable-container').forEach(container => {
                    const preview = container.querySelector('.markdown-preview');
                    const editor = container.querySelector('textarea');

                    if (preview && editor) {
                        preview.addEventListener('click', () => {
                            preview.classList.add('hidden');
                            editor.classList.remove('hidden');
                            editor.focus();
                            autoResizeTextarea(editor);
                        });

                        editor.addEventListener('blur', () => {
                            editor.classList.add('hidden');
                            preview.classList.remove('hidden');
                            updateMarkdownPreview(editor);
                        });
                    }
                });

                document.querySelectorAll(savableSelector).forEach(el => {
                    el.addEventListener('input', () => {
                        saveContent();
                        if (el.tagName === 'TEXTAREA') autoResizeTextarea(el);
                    });
                });

                for (let i = 1; i <= screenshotCount; i++) {
                    const input = document.getElementById(`screenshot-input-${i}`);
                    if (input) {
                        input.addEventListener('change', (event) => {
                            const preview = document.getElementById(`screenshot-preview-${i}`);
                            const placeholder = document.getElementById(`screenshot-placeholder-${i}`);
                            const file = event.target.files[0];
                            if (file) {
                                const reader = new FileReader();
                                reader.onload = (e) => {
                                    preview.src = e.target.result;
                                    preview.classList.remove('hidden');
                                    if (placeholder) placeholder.classList.add('hidden');
                                    saveContent();
                                }
                                reader.readAsDataURL(file);
                            }
                        });
                    }
                }
                
                if (exportBtn) exportBtn.addEventListener('click', exportToPdf);

                loadContent();
            }

            initialize();
        });
    </script>
</body>
</html>

