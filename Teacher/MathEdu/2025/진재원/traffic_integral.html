<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì„œìš¸ êµí†µëŸ‰-ì‹œê°„ ì ë¶„ (ì‹¤ì‹œê°„)</title>
  <link rel="canonical" href="https://jinjw27.github.io/Webpage/traffic_integral.html" />

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    /* (1) ë‹¤í¬/ë¼ì´íŠ¸ ëª¨ë“œ í…Œë§ˆ ë³€ìˆ˜ */
    :root {
      --bg-color: #f4f7f6;
      --text-color: #333;
      --card-bg: #ffffff;
      --border-color: #ddd;
      --primary-color: #007bff;
      --primary-hover: #0056b3;
      --secondary-color: #6c757d;
      --highlight-color: rgba(255, 99, 132, 0.8);
      --default-color: rgba(54, 162, 235, 0.6);
      --chart-grid-color: rgba(0, 0, 0, 0.1);
      --chart-tick-color: #666;
    }

    [data-theme="dark"] {
      --bg-color: #121212;
      --text-color: #e0e0e0;
      --card-bg: #1e1e1e;
      --border-color: #444;
      --primary-color: #0a84ff;
      --primary-hover: #0060df;
      --secondary-color: #8e8e93;
      --chart-grid-color: rgba(255, 255, 255, 0.1);
      --chart-tick-color: #bbb;
    }

    /* (ê¸°íƒ€ ìŠ¤íƒ€ì¼ì€ ì´ì „ê³¼ ë™ì¼...) */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Malgun Gothic", "Apple SD Gothic Neo", sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      background-color: var(--card-bg);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    h1 {
      margin: 0;
      font-size: 1.8em;
    }

    .theme-switch-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .theme-switch {
      display: inline-block;
      height: 24px;
      position: relative;
      width: 44px;
    }

    .theme-switch input {
      display: none;
    }

    .slider {
      background-color: #ccc;
      bottom: 0;
      cursor: pointer;
      left: 0;
      position: absolute;
      right: 0;
      top: 0;
      transition: 0.4s;
      border-radius: 34px;
    }

    .slider:before {
      background-color: #fff;
      bottom: 4px;
      content: "";
      height: 16px;
      left: 4px;
      position: absolute;
      transition: 0.4s;
      width: 16px;
      border-radius: 50%;
    }

    input:checked+.slider {
      background-color: var(--primary-color);
    }

    input:checked+.slider:before {
      transform: translateX(20px);
    }

    .content-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 1024px) {
      .content-grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background-color: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.07);
      padding: 25px;
      border: 1px solid var(--border-color);
      transition: background-color 0.3s, border-color 0.3s;
    }

    .card h2 {
      margin-top: 0;
      margin-bottom: 15px;
      font-size: 1.3em;
    }

    #map {
      height: 500px;
      border-radius: 8px;
      border: 2px solid var(--border-color);
    }

    /* (3) ìš”ì¼ë³„ ë·° ë²„íŠ¼ í¬í•¨ */
    .view-selector {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .view-button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      border: 2px solid var(--border-color);
      background-color: var(--card-bg);
      color: var(--text-color);
      border-radius: 8px;
      transition: all 0.3s;
      font-weight: 500;
    }

    .view-button:hover {
      border-color: var(--primary-color);
      transform: translateY(-2px);
    }

    .view-button.active {
      background-color: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    #chartContainer {
      width: 100%;
      height: 350px;
      margin: 20px 0;
    }

    .controls {
      display: flex;
      gap: 15px;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 20px;
    }

    .controls label {
      font-weight: bold;
    }

    .controls select,
    .controls button {
      padding: 10px 14px;
      border: 1px solid var(--border-color);
      background-color: var(--card-bg);
      color: var(--text-color);
      border-radius: 6px;
      font-size: 16px;
    }

    .controls button {
      background-color: var(--primary-color);
      color: white;
      cursor: pointer;
      border: none;
      font-weight: bold;
      transition: background-color 0.3s;
    }

    .controls button:hover {
      background-color: var(--primary-hover);
    }

    #result {
      margin-top: 20px;
      font-size: 1.3em;
      font-weight: bold;
      color: var(--primary-color);
      text-align: center;
      padding: 15px;
      background-color: var(--bg-color);
      border-radius: 8px;
      min-height: 1.5em;
    }

    .location-info {
      text-align: center;
      margin-bottom: 15px;
    }

    .location-name {
      font-size: 1.3em;
      font-weight: bold;
      color: var(--text-color);
      margin-bottom: 8px;
    }

    /* (1) í‰ê·  í˜¼ì¡ë„ í‘œì‹œ */
    .traffic-stats {
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .stat-item {
      padding: 8px 15px;
      background-color: var(--bg-color);
      border-radius: 8px;
      font-size: 0.95em;
    }

    .stat-label {
      color: var(--secondary-color);
      margin-right: 5px;
    }

    .stat-value {
      font-weight: bold;
      color: var(--text-color);
    }

    /* (ì¶œì²˜) */
    footer {
      margin-top: 30px;
      text-align: center;
      font-size: 0.9em;
      color: var(--secondary-color);
      background-color: var(--card-bg);
      padding: 20px;
      border-radius: 12px;
    }

    footer a {
      color: var(--primary-color);
      text-decoration: none;
    }

    footer a:hover {
      text-decoration: underline;
    }

    /* (1) í˜„ì¬ í˜¼ì¡ë„ ë§ˆì»¤ */
    .traffic-marker {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: white;
      font-size: 12px;
      border: 3px solid white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      cursor: pointer;
      transition: transform 0.2s;
    }

    .traffic-marker:hover {
      transform: scale(1.2);
    }

    .legend {
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 5px 0;
      font-size: 12px;
    }

    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid white;
    }

    .current-time-info {
      text-align: center;
      font-size: 0.9em;
      color: var(--secondary-color);
      margin-bottom: 10px;
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>ğŸš— ì„œìš¸ ì‹¤ì‹œê°„ êµí†µëŸ‰-ì‹œê°„ ì ë¶„ ë¶„ì„</h1>
      <div class="theme-switch-wrapper">
        <span>â˜€ï¸</span>
        <label class="theme-switch">
          <input type="checkbox" id="theme-toggle" />
          <span class="slider"></span>
        </label>
        <span>ğŸŒ™</span>
      </div>
    </header>

    <div class="content-grid">
      <div class="card">
        <h2>ğŸ“ ì„œìš¸ì‹œ ì£¼ìš” ì§€ì  êµí†µëŸ‰ ì§€ë„</h2>
        <div class="current-time-info" id="currentTimeInfo">
          í˜„ì¬ ì‹œê°„: <strong id="currentHour"></strong>
        </div>
        <p style="
              text-align: center;
              color: var(--secondary-color);
              margin-bottom: 15px;
            ">
          ë§ˆì»¤ë¥¼ í´ë¦­í•˜ì—¬ í•´ë‹¹ ì§€ì ì˜ êµí†µëŸ‰ ë°ì´í„°ë¥¼ í™•ì¸í•˜ì„¸ìš”<br />
          (ë§ˆì»¤ ìƒ‰ìƒì€ í˜„ì¬ ì‹œê°„ëŒ€ì˜ í˜¼ì¡ë„ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤)
        </p>
        <div id="map"></div>
      </div>

      <div class="card">
        <h2>ğŸ“Š êµí†µëŸ‰ ë¶„ì„ ì°¨íŠ¸</h2>

        <div class="location-info">
          <div class="location-name" id="currentLocation">
            ì§€ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”
          </div>
          <div class="traffic-stats" id="trafficStats" style="display: none">
            <div class="stat-item">
              <span class="stat-label">í˜„ì¬ êµí†µëŸ‰:</span>
              <span class="stat-value" id="currentTraffic">-</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">í‰ê·  êµí†µëŸ‰:</span>
              <span class="stat-value" id="avgTraffic">-</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">í‰ê·  í˜¼ì¡ë„:</span>
              <span class="stat-value" id="avgCongestion">-</span>
            </div>
          </div>
        </div>

        <div class="view-selector">
          <button class="view-button active" onclick="changeView('today')">
            ì˜¤ëŠ˜
          </button>
          <button class="view-button" onclick="changeView('yesterday')">
            ì–´ì œ
          </button>
          <button class="view-button" onclick="changeView('weekly')">
            ìš”ì¼ë³„ í‰ê· 
          </button>
        </div>

        <div id="chartContainer">
          <canvas id="trafficChart"></canvas>
        </div>

        <hr style="
              border: none;
              border-top: 1px solid var(--border-color);
              margin: 20px 0;
            " />

        <div class="controls" id="integralControls">
          <label for="startTime">ì‹œì‘ ì‹œê°„:</label>
          <select id="startTime"></select>
          <label for="endTime">ì¢…ë£Œ ì‹œê°„:</label>
          <select id="endTime"></select>
          <button onclick="calculateIntegral()">ğŸ“ˆ ëˆ„ì  êµí†µëŸ‰ ê³„ì‚°</button>
        </div>

        <div id="result">ì§€ë„ì—ì„œ ì§€ì ì„ ì„ íƒí•˜ê³  ì‹œê°„ ë²”ìœ„ë¥¼ ì„¤ì •í•˜ì„¸ìš”</div>
      </div>
    </div>

    <footer>
      <p><strong>ğŸ“Œ ë°ì´í„° ì¶œì²˜</strong></p>
      <p>
        ë³¸ ì‹œê°í™”ëŠ”
        <a href="https://data.seoul.go.kr/SeoulRtd/list" target="_blank" rel="noopener noreferrer">ì„œìš¸ ì—´ë¦°ë°ì´í„° ê´‘ì¥ - ì‹¤ì‹œê°„
          ë„ì‹œë°ì´í„°</a>ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.
      </p>
      <p style="margin-top: 10px; font-size: 0.85em">
        ì‹¤ì‹œê°„ êµí†µëŸ‰ ë°ì´í„°ë¥¼ í™œìš©í•˜ì—¬ êµí†µëŸ‰-ì‹œê°„ ì ë¶„ ê°œë…ì„
        ì‹œê°í™”í•˜ì˜€ìŠµë‹ˆë‹¤.<br />
        ì ë¶„ ê°’ì€ ì„ íƒí•œ ì‹œê°„ êµ¬ê°„ ë™ì•ˆì˜ ëˆ„ì  ì°¨ëŸ‰ ëŒ€ìˆ˜ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
      </p>
    </footer>
  </div>

  <script>
    // --- (2) ì„œìš¸ì‹œ ì£¼ìš” êµí†µ ì§€ì  12ê³³ ---
    const trafficLocations = [
      { name: "ê°•ë‚¨ì—­ ì‚¬ê±°ë¦¬", lat: 37.4979, lng: 127.0276, id: "gangnam" },
      {
        name: "ê´‘í™”ë¬¸ ì‚¬ê±°ë¦¬",
        lat: 37.572,
        lng: 126.9769,
        id: "gwanghwamun",
      },
      { name: "ì—¬ì˜ë„ ì‚¬ê±°ë¦¬", lat: 37.5219, lng: 126.9245, id: "yeouido" },
      { name: "ì‹œì²­ì—­ ì‚¬ê±°ë¦¬", lat: 37.5662, lng: 126.9779, id: "cityhall" },
      { name: "ì ì‹¤ëŒ€êµ ë¶ë‹¨", lat: 37.5172, lng: 127.0856, id: "jamsil" },
      { name: "í•œë‚¨ëŒ€êµ ë¶ë‹¨", lat: 37.5366, lng: 127.0046, id: "hannam" },
      { name: "ì„±ìˆ˜ëŒ€êµ ë¶ë‹¨", lat: 37.5447, lng: 127.0411, id: "seongsu" },
      { name: "ì‹ ì´Œ ë¡œí„°ë¦¬", lat: 37.5556, lng: 126.9364, id: "sinchon" },
      { name: "ì„œìš¸ì—­ ì•", lat: 37.5547, lng: 126.9707, id: "seoulstation" },
      { name: "ì¢…ë¡œ3ê°€ ì‚¬ê±°ë¦¬", lat: 37.5703, lng: 126.992, id: "jongno3" },
      { name: "êµëŒ€ì—­ ì‚¬ê±°ë¦¬", lat: 37.4933, lng: 127.0143, id: "kyodae" },
      { name: "êµ¬ë¡œë””ì§€í„¸ë‹¨ì§€ì—­", lat: 37.485, lng: 126.9013, id: "guro" },
    ];

    // --- (1) í˜„ì¬ ì‹œê°„ (ì§€ë„ ë§ˆì»¤ìš©) ---
    const currentHour = new Date().getHours();
    document.getElementById("currentHour").textContent = `${currentHour}ì‹œ`;

    // --- í˜¼ì¡ë„ ê³„ì‚° í•¨ìˆ˜ ---
    // í˜¼ì¡ë„ ìƒ‰ìƒ
    function getCongestionColor(traffic) {
      if (traffic < 500) return "#4CAF50"; // ì›í™œ
      if (traffic < 1000) return "#FFC107"; // ë³´í†µ
      if (traffic < 1500) return "#FF9800"; // í˜¼ì¡
      if (traffic < 2000) return "#FF5722"; // ë§¤ìš°í˜¼ì¡
      return "#D32F2F"; // ê·¹ì‹¬í˜¼ì¡
    }
    // í˜¼ì¡ë„ í…ìŠ¤íŠ¸
    function getCongestionText(traffic) {
      if (traffic < 500) return "ì›í™œ";
      if (traffic < 1000) return "ë³´í†µ";
      if (traffic < 1500) return "í˜¼ì¡";
      if (traffic < 2000) return "ë§¤ìš°í˜¼ì¡";
      return "ê·¹ì‹¬í˜¼ì¡";
    }

    // --- ê°€ìƒ ë°ì´í„° ìƒì„±ê¸° (ì„œìš¸ì‹œ ë°ì´í„° ì‹œë®¬ë ˆì´ì…˜) ---
    // ì‹œê°„ëŒ€ë³„ êµí†µëŸ‰ ìƒì„± (ì˜¤ëŠ˜/ì–´ì œ)
    function generateRealisticTrafficData(locationId, isToday = true) {
      // (ì§€ì ë³„ 24ì‹œê°„ ê¸°ë³¸ íŒ¨í„´ - ì‹¤ì œ ë°ì´í„°ë¡œ êµì²´ ê°€ëŠ¥)
      const basePatterns = {
        gangnam: [
          300, 200, 150, 200, 350, 700, 1800, 2500, 2200, 1500, 1300, 1400,
          1500, 1600, 1700, 1800, 2000, 2800, 3000, 2400, 1500, 1000, 800,
          500,
        ],
        gwanghwamun: [
          150, 100, 80, 100, 200, 450, 1100, 1900, 1600, 1200, 1100, 1300,
          1400, 1350, 1400, 1500, 1700, 2100, 2300, 1800, 1000, 700, 500, 300,
        ],
        yeouido: [
          100, 80, 70, 90, 150, 500, 1700, 2400, 2000, 1000, 800, 850, 900,
          950, 1000, 1100, 1500, 2600, 2700, 2000, 1100, 700, 400, 200,
        ],
        cityhall: [
          200, 150, 120, 150, 300, 600, 1400, 2000, 1800, 1300, 1200, 1350,
          1450, 1500, 1550, 1600, 1800, 2200, 2500, 2000, 1200, 800, 600, 400,
        ],
        jamsil: [
          250, 180, 140, 180, 320, 650, 1500, 2200, 1900, 1400, 1250, 1380,
          1480, 1520, 1600, 1700, 1900, 2400, 2600, 2100, 1300, 900, 700, 450,
        ],
        hannam: [
          180, 130, 100, 130, 280, 580, 1300, 1900, 1700, 1200, 1100, 1250,
          1350, 1400, 1450, 1550, 1750, 2100, 2300, 1900, 1100, 750, 550, 350,
        ],
        seongsu: [
          220, 160, 130, 160, 310, 620, 1450, 2100, 1850, 1350, 1220, 1330,
          1430, 1480, 1580, 1680, 1880, 2300, 2550, 2050, 1250, 850, 650, 420,
        ],
        sinchon: [
          280, 200, 160, 200, 340, 680, 1550, 2300, 2000, 1450, 1280, 1400,
          1500, 1550, 1650, 1750, 1950, 2500, 2700, 2200, 1400, 950, 750, 480,
        ],
        seoulstation: [
          240, 170, 135, 170, 330, 670, 1520, 2250, 2050, 1480, 1300, 1420,
          1520, 1570, 1670, 1770, 1970, 2450, 2650, 2150, 1350, 900, 700, 460,
        ],
        jongno3: [
          210, 150, 125, 150, 290, 610, 1380, 2050, 1820, 1330, 1230, 1360,
          1460, 1510, 1610, 1710, 1910, 2350, 2580, 2080, 1280, 870, 670, 440,
        ],
        kyodae: [
          260, 190, 145, 190, 325, 660, 1510, 2210, 1920, 1420, 1270, 1400,
          1500, 1540, 1640, 1740, 1940, 2420, 2620, 2120, 1320, 920, 720, 470,
        ],
        guro: [
          230, 165, 132, 165, 315, 640, 1490, 2180, 1980, 1450, 1290, 1410,
          1510, 1560, 1660, 1760, 1960, 2380, 2600, 2100, 1300, 890, 690, 450,
        ],
      };
      const pattern = basePatterns[locationId] || basePatterns.gangnam;
      const variation = isToday ? 1 : 0.85; // ì–´ì œëŠ” 85% ìˆ˜ì¤€ìœ¼ë¡œ ê°€ì •

      // ë°ì´í„°ì— ì•½ê°„ì˜ ëœë¤ì„± ë¶€ì—¬
      return pattern.map((val) =>
        Math.floor(val * variation * (0.9 + Math.random() * 0.2))
      );
    }

    // --- (3) ìš”ì¼ë³„ í‰ê·  ë°ì´í„° ìƒì„± ---
    function generateWeeklyData(locationId) {
      const baseData = generateRealisticTrafficData(locationId, true); // ì˜¤ëŠ˜ ë°ì´í„°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ
      const weekdays = ["ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† ", "ì¼"];
      const variations = [1.0, 1.02, 1.01, 1.03, 1.05, 0.85, 0.75]; // ìš”ì¼/ì£¼ë§ í¸ì°¨

      return weekdays.map((day, idx) => {
        // 24ì‹œê°„ í‰ê· ì— ìš”ì¼ë³„ í¸ì°¨ ì ìš©
        const avgTraffic = Math.floor(
          (baseData.reduce((a, b) => a + b, 0) / 24) * variations[idx]
        );
        return avgTraffic;
      });
    }

    // --- ì§€ë„ ì´ˆê¸°í™” ---
    const map = L.map("map").setView([37.5665, 126.978], 11); // ì„œìš¸ ì¤‘ì‹¬

    // ì˜¤í”ˆìŠ¤íŠ¸ë¦¬íŠ¸ë§µ íƒ€ì¼ ë ˆì´ì–´
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "Â© OpenStreetMap contributors",
    }).addTo(map);

    // --- (1) í˜¼ì¡ë„ ë²”ë¡€ ì¶”ê°€ ---
    const legend = L.control({ position: "bottomright" });
    legend.onAdd = function (map) {
      const div = L.DomUtil.create("div", "legend");
      div.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 8px;">í˜„ì¬ ì‹œê°„ëŒ€ í˜¼ì¡ë„</div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #4CAF50;"></div>
                    <span>ì›í™œ (&lt;500)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #FFC107;"></div>
                    <span>ë³´í†µ (500-1000)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #FF9800;"></div>
                    <span>í˜¼ì¡ (1000-1500)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #FF5722;"></div>
                    <span>ë§¤ìš°í˜¼ì¡ (1500-2000)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #D32F2F;"></div>
                    <span>ê·¹ì‹¬í˜¼ì¡ (&gt;2000)</span>
                </div>
            `;
      return div;
    };
    legend.addTo(map);

    // --- ì „ì—­ ë³€ìˆ˜ ---
    let currentLocation = null;
    let currentView = "today";
    let trafficChart = null;
    let markers = []; // ë§ˆì»¤ ì €ì¥ (ë‚˜ì¤‘ì— ì°¸ì¡°í•  ìˆ˜ ìˆë„ë¡)

    // --- ì°¨íŠ¸ ì´ˆê¸°í™” (ë¹ˆ ì°¨íŠ¸) ---
    const ctx = document.getElementById("trafficChart").getContext("2d");
    const labels = Array.from({ length: 24 }, (_, i) => `${i}ì‹œ`); // 24ì‹œê°„ Xì¶•

    function initChart() {
      trafficChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [
            {
              label: "ì‹œê°„ë‹¹ êµí†µëŸ‰ (ëŒ€/ì‹œê°„)",
              data: Array(24).fill(0), // ë¹ˆ ë°ì´í„°ë¡œ ì‹œì‘
              backgroundColor: Array(24).fill("rgba(54, 162, 235, 0.6)"),
              borderWidth: 0,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false, // ì»¨í…Œì´ë„ˆ ë†’ì´ì— ë§ì¶¤
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: "êµí†µëŸ‰ (ëŒ€/ì‹œê°„)",
                color: "var(--chart-tick-color)",
              },
              grid: { color: "var(--chart-grid-color)" },
              ticks: { color: "var(--chart-tick-color)" },
            },
            x: {
              title: {
                display: true,
                text: "ì‹œê°„ (t)",
                color: "var(--chart-tick-color)",
              },
              grid: { color: "var(--chart-grid-color)" },
              ticks: { color: "var(--chart-tick-color)" },
            },
          },
          plugins: {
            legend: { labels: { color: "var(--chart-tick-color)" } },
            tooltip: {
              callbacks: {
                label: (context) =>
                  ` ${context.parsed.y.toLocaleString()} ëŒ€/ì‹œê°„`,
              },
            },
          },
        },
      });
    }

    // --- (1) + (2) ë§ˆì»¤ ìƒì„± ë° ì§€ë„ì— ì¶”ê°€ ---
    function createMarkers() {
      trafficLocations.forEach((location) => {
        const data = generateRealisticTrafficData(location.id, true); // 'ì˜¤ëŠ˜' ë°ì´í„° ê¸°ì¤€

        // (1) 'í˜„ì¬ ì‹œê°„' êµí†µëŸ‰ìœ¼ë¡œ ìƒ‰ìƒ ê²°ì •
        const currentTraffic = data[currentHour];
        const color = getCongestionColor(currentTraffic);
        const status = getCongestionText(currentTraffic);

        // (1) 'í‰ê· ' êµí†µëŸ‰ (íŒì—… ì •ë³´ìš©)
        const avgTraffic = Math.floor(data.reduce((a, b) => a + b, 0) / 24);

        // ë§ˆì»¤ ì•„ì´ì½˜ (í˜„ì¬ êµí†µëŸ‰ í‘œì‹œ)
        const icon = L.divIcon({
          className: "custom-icon", // CSSì—ì„œ ìŠ¤íƒ€ì¼ë§í•˜ì§€ ì•ŠìŒ (ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ ì‚¬ìš©)
          html: `<div class="traffic-marker" style="background-color: ${color};">${currentTraffic}</div>`,
          iconSize: [40, 40],
        });

        const marker = L.marker([location.lat, location.lng], { icon: icon })
          .addTo(map)
          .bindPopup(
            `
                        <strong>${location.name}</strong><br>
                        í˜„ì¬(${currentHour}ì‹œ) êµí†µëŸ‰: ${currentTraffic.toLocaleString()} ëŒ€/ì‹œê°„<br>
                        í˜„ì¬ í˜¼ì¡ë„: <strong style="color: ${color};">${status}</strong><br>
                        ì¼í‰ê·  êµí†µëŸ‰: ${avgTraffic.toLocaleString()} ëŒ€/ì‹œê°„
                    `
          )
          .on("click", () => selectLocation(location)); // í´ë¦­ ì‹œ ì°¨íŠ¸ ì—…ë°ì´íŠ¸

        markers.push({ marker, location, data });
      });
    }

    // --- ìœ„ì¹˜ ì„ íƒ ì‹œ ì´ë²¤íŠ¸ ---
    function selectLocation(location) {
      currentLocation = location;
      document.getElementById("currentLocation").textContent = location.name; // ì§€ì  ì´ë¦„ ì—…ë°ì´íŠ¸
      document.getElementById("trafficStats").style.display = "flex"; // í†µê³„ ì¹´ë“œ ë³´ì´ê¸°

      // ë§µì„ ë¶€ë“œëŸ½ê²Œ í•´ë‹¹ ìœ„ì¹˜ë¡œ ì´ë™
      map.flyTo([location.lat, location.lng], 13);

      updateChart(); // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
    }

    // --- (3) ë·° ë³€ê²½ ì‹œ ì´ë²¤íŠ¸ ---
    function changeView(view) {
      currentView = view;

      // ë²„íŠ¼ í™œì„±í™” ìŠ¤íƒ€ì¼ ë³€ê²½
      document
        .querySelectorAll(".view-button")
        .forEach((btn) => btn.classList.remove("active"));
      event.target.classList.add("active");

      // ìš”ì¼ë³„ í‰ê· ì¼ ë•ŒëŠ” ì ë¶„ ì»¨íŠ¸ë¡¤ ìˆ¨ê¸°ê¸°
      if (view === "weekly") {
        document.getElementById("integralControls").style.display = "none";
      } else {
        document.getElementById("integralControls").style.display = "flex";
      }

      // í˜„ì¬ ìœ„ì¹˜ê°€ ì„ íƒëœ ìƒíƒœë¼ë©´ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
      if (currentLocation) updateChart();
    }

    // --- ğŸŒŸ ì°¨íŠ¸ ì—…ë°ì´íŠ¸ (í•µì‹¬ ë¡œì§) ğŸŒŸ ---
    // (ì—¬ê¸°ê°€ ì˜ë ¸ë˜ ë¶€ë¶„ì…ë‹ˆë‹¤)
    function updateChart() {
      if (!currentLocation) return; // ì„ íƒëœ ìœ„ì¹˜ê°€ ì—†ìœ¼ë©´ ì¤‘ë‹¨

      // (3) ìš”ì¼ë³„ ë·° ì²˜ë¦¬
      if (currentView === "weekly") {
        const weeklyData = generateWeeklyData(currentLocation.id);
        const weekdays = ["ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† ", "ì¼"];

        trafficChart.data.labels = weekdays; // Xì¶•ì„ ìš”ì¼ë¡œ ë³€ê²½
        trafficChart.data.datasets[0].data = weeklyData;
        trafficChart.data.datasets[0].label = "ìš”ì¼ë³„ í‰ê·  êµí†µëŸ‰ (ëŒ€/ì‹œê°„)";
        trafficChart.data.datasets[0].backgroundColor = weekdays.map(
          (_, idx) =>
            idx >= 5 ? "rgba(255, 152, 0, 0.6)" : "rgba(54, 162, 235, 0.6)" // ì£¼ë§/ì£¼ì¤‘ ìƒ‰ìƒ êµ¬ë¶„
        );
        trafficChart.options.scales.x.title.text = "ìš”ì¼";

        document.getElementById("result").textContent =
          "ìš”ì¼ë³„ í‰ê·  êµí†µëŸ‰ì„ í™•ì¸í•˜ì„¸ìš”.";
        document.getElementById("result").style.color = "var(--text-color)";

        // (1) í†µê³„ ì—…ë°ì´íŠ¸ (ì£¼ê°„ í‰ê· )
        const avgWeekly = Math.floor(
          weeklyData.reduce((a, b) => a + b, 0) / 7
        ); // <-- ì—¬ê¸°ê°€ ì˜ë¦° ë¶€ë¶„

        document.getElementById("currentTraffic").textContent = "-"; // ì£¼ê°„ í‰ê· ì—ëŠ” 'í˜„ì¬'ê°€ ì—†ìŒ
        document.getElementById(
          "avgTraffic"
        ).textContent = `${avgWeekly.toLocaleString()} ëŒ€`;
        document.getElementById("avgCongestion").textContent =
          getCongestionText(avgWeekly);
      } else {
        // 'ì˜¤ëŠ˜' ë˜ëŠ” 'ì–´ì œ' ë·° ì²˜ë¦¬
        const isToday = currentView === "today";
        const data = generateRealisticTrafficData(
          currentLocation.id,
          isToday
        );

        trafficChart.data.labels = labels; // Xì¶•ì„ 24ì‹œê°„ìœ¼ë¡œ ë³µì›
        trafficChart.data.datasets[0].data = data;
        trafficChart.data.datasets[0].label = `${isToday ? "ì˜¤ëŠ˜" : "ì–´ì œ"
          } ì‹œê°„ë‹¹ êµí†µëŸ‰ (ëŒ€/ì‹œê°„)`;

        // ì°¨íŠ¸ ìƒ‰ìƒ ì´ˆê¸°í™” (ì ë¶„ í•˜ì´ë¼ì´íŠ¸ ì œê±°)
        const defaultBarColor = getComputedStyle(document.documentElement)
          .getPropertyValue("--default-color")
          .trim();
        trafficChart.data.datasets[0].backgroundColor =
          Array(24).fill(defaultBarColor);
        trafficChart.options.scales.x.title.text = "ì‹œê°„ (t)";

        // (1) í†µê³„ ì—…ë°ì´íŠ¸ (ì¼ê°„ í‰ê· )
        const currentTraffic = data[currentHour];
        const avgTraffic = Math.floor(data.reduce((a, b) => a + b, 0) / 24);

        document.getElementById("currentTraffic").textContent = `${isToday ? currentTraffic.toLocaleString() : "-"
          } ëŒ€`;
        document.getElementById(
          "avgTraffic"
        ).textContent = `${avgTraffic.toLocaleString()} ëŒ€`;
        document.getElementById("avgCongestion").textContent =
          getCongestionText(avgTraffic);

        // ì ë¶„ ê³„ì‚°ê¸° ê²°ê³¼ì°½ ì´ˆê¸°í™” (ê¸°ë³¸ê°’ìœ¼ë¡œ ê³„ì‚°)
        calculateIntegral();
      }

      // ì°¨íŠ¸ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
      trafficChart.update();
    }

    // --- ì ë¶„ ê³„ì‚° (ëˆ„ì  êµí†µëŸ‰) ---
    function calculateIntegral() {
      if (currentView === "weekly" || !currentLocation) return; // ì£¼ê°„ ë·°ì—ì„œëŠ” ì‹¤í–‰ ì•ˆ í•¨

      const startIdx = parseInt(document.getElementById("startTime").value);
      const endIdx = parseInt(document.getElementById("endTime").value);
      const resultDiv = document.getElementById("result");

      // CSS ë³€ìˆ˜ì—ì„œ í…Œë§ˆì— ë§ëŠ” ìƒ‰ìƒ ê°’ì„ ê°€ì ¸ì˜´
      const highlightColor = getComputedStyle(document.documentElement)
        .getPropertyValue("--highlight-color")
        .trim();
      const defaultColor = getComputedStyle(document.documentElement)
        .getPropertyValue("--default-color")
        .trim();

      let barColors = Array(24).fill(defaultColor);

      if (startIdx > endIdx) {
        resultDiv.textContent =
          "ì˜¤ë¥˜: ì‹œì‘ ì‹œê°„ì€ ì¢…ë£Œ ì‹œê°„ë³´ë‹¤ ë¹ ë¥´ê±°ë‚˜ ê°™ì•„ì•¼ í•©ë‹ˆë‹¤.";
        resultDiv.style.color = "#d9534f"; // ì˜¤ë¥˜ ìƒ‰ìƒ
        return;
      }

      let cumulativeTraffic = 0;
      const currentData = trafficChart.data.datasets[0].data;

      // ë¦¬ë§Œ í•© (Riemann Sum) ê³„ì‚°: Î£ q(t_i) * Î”t (ì—¬ê¸°ì„œ Î”t = 1ì‹œê°„)
      for (let i = startIdx; i <= endIdx; i++) {
        cumulativeTraffic += currentData[i];
        barColors[i] = highlightColor; // ì„ íƒëœ ë²”ìœ„ ê°•ì¡°
      }

      trafficChart.data.datasets[0].backgroundColor = barColors;
      trafficChart.update(); // ì°¨íŠ¸ ì—…ë°ì´íŠ¸ë¡œ ìƒ‰ìƒ ë³€ê²½ ì ìš©

      // ê²°ê³¼ í‘œì‹œ (ìˆ«ìì— ì½¤ë§ˆ ì¶”ê°€)
      resultDiv.textContent = `[${startIdx}ì‹œ ~ ${endIdx}ì‹œ] ì´ ëˆ„ì  êµí†µëŸ‰: ${cumulativeTraffic.toLocaleString()} ëŒ€`;
      resultDiv.style.color = "var(--primary-color)";
    }

    // --- ì‹œê°„ ì„ íƒ <select> ì˜µì…˜ ìƒì„± (0ì‹œ~23ì‹œ) ---
    function initTimeSelectors() {
      const startTimeSelect = document.getElementById("startTime");
      const endTimeSelect = document.getElementById("endTime");

      labels.forEach((label, index) => {
        startTimeSelect.options.add(new Option(label, index));
        endTimeSelect.options.add(new Option(label, index));
      });
      // ì¶œê·¼ ì‹œê°„(7-9ì‹œ)ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
      startTimeSelect.value = 7;
      endTimeSelect.value = 9;
    }

    // --- ë‹¤í¬/ë¼ì´íŠ¸ ëª¨ë“œ í…Œë§ˆ ê´€ë¦¬ ---
    const themeToggle = document.getElementById("theme-toggle");

    // ì°¨íŠ¸ì™€ ì§€ë„ íƒ€ì¼ì˜ í…Œë§ˆë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
    function updateChartTheme() {
      const isDark = document.body.getAttribute("data-theme") === "dark";
      const gridColor = isDark
        ? "rgba(255, 255, 255, 0.1)"
        : "rgba(0, 0, 0, 0.1)";
      const tickColor = isDark ? "#bbb" : "#666";

      // ì°¨íŠ¸ í…Œë§ˆ ì—…ë°ì´íŠ¸
      if (trafficChart) {
        trafficChart.options.scales.y.grid.color = gridColor;
        trafficChart.options.scales.y.ticks.color = tickColor;
        trafficChart.options.scales.y.title.color = tickColor;
        trafficChart.options.scales.x.grid.color = gridColor;
        trafficChart.options.scales.x.ticks.color = tickColor;
        trafficChart.options.scales.x.title.color = tickColor;
        trafficChart.options.plugins.legend.labels.color = tickColor;
        trafficChart.update();
      }

      // ì§€ë„ íƒ€ì¼ í…Œë§ˆ (í•„í„° ì ìš©ìœ¼ë¡œ ì–´ë‘¡ê²Œ)
      const mapTile = document.querySelector(".leaflet-tile-container");
      if (mapTile) {
        mapTile.style.filter = isDark
          ? "invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%)"
          : "none";
      }
      // ì§€ë„ ë²”ë¡€ í…Œë§ˆ
      const legendControl = document.querySelector(".legend");
      if (legendControl) {
        legendControl.style.background = isDark ? "#333" : "white";
        legendControl.style.color = isDark ? "#eee" : "#333";
      }
    }

    // í…Œë§ˆ í† ê¸€ ìŠ¤ìœ„ì¹˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    themeToggle.addEventListener("change", function () {
      if (this.checked) {
        document.body.setAttribute("data-theme", "dark");
        localStorage.setItem("theme", "dark");
      } else {
        document.body.setAttribute("data-theme", "light");
        localStorage.setItem("theme", "light");
      }
      updateChartTheme(); // í…Œë§ˆ ë³€ê²½ ì‹œ ì°¨íŠ¸/ì§€ë„ ì—…ë°ì´íŠ¸
    });

    // ì´ˆê¸° í…Œë§ˆ ì„¤ì • (ì‹œìŠ¤í…œ ì„¤ì • ë˜ëŠ” ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ê°’ í™•ì¸)
    function setInitialTheme() {
      const currentTheme = localStorage.getItem("theme")
        ? localStorage.getItem("theme")
        : null;
      if (currentTheme) {
        document.body.setAttribute("data-theme", currentTheme);
        if (currentTheme === "dark") {
          themeToggle.checked = true;
        }
      } else if (
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches
      ) {
        // ì‚¬ìš©ìê°€ ì‹œìŠ¤í…œ ë‹¤í¬ ëª¨ë“œë¥¼ ì„ í˜¸í•˜ëŠ” ê²½ìš°
        document.body.setAttribute("data-theme", "dark");
        themeToggle.checked = true;
      }
    }

    // --- í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” ì‹¤í–‰ ---
    setInitialTheme();
    initChart();
    initTimeSelectors();
    createMarkers();
    updateChartTheme(); // ì´ˆê¸° ë¡œë“œ ì‹œ í…Œë§ˆ ì ìš©
  </script>
</body>

</html>