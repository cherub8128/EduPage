<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>보고서 빌더</title>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <!-- Add Showdown.js for the builder itself -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;600&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        .preview-serif { font-family: 'Noto Serif KR', serif; }
        .preview-sans { font-family: 'Noto Sans KR', sans-serif; }
        /* Paper Sizes */
        .preview-a0 { width: 841mm; min-height: 1189mm; }
        .preview-a1 { width: 594mm; min-height: 841mm; }
        .preview-a2 { width: 420mm; min-height: 594mm; }
        .preview-a3 { width: 297mm; min-height: 420mm; }
        .preview-a4 { width: 210mm; min-height: 297mm; }
        .preview-b4 { width: 250mm; min-height: 353mm; }
        .preview-b5 { width: 176mm; min-height: 250mm; }
        .preview-letter { width: 8.5in; min-height: 11in; }
        .preview-web { width: 100%; max-width: 900px; min-height: 1280px; }
        
        .component { position: relative; padding: 0.5rem; margin-bottom: 1rem; border: 1px dashed transparent; transition: background-color 0.2s; }
        .component:hover { border-color: #93c5fd; background-color: rgba(239, 246, 255, 0.5); }
        .component.dragging { opacity: 0.4; }
        
        .component-controls { position: absolute; top: 50%; left: -32px; transform: translateY(-50%); display: flex; align-items: center; gap: 4px; opacity: 0; transition: opacity 0.2s; z-index: 10; }
        .component:hover > .component-controls { opacity: 1; }
        
        .component-handle { cursor: grab; }
        .component-handle:active { cursor: grabbing; }
        .delete-btn { cursor: pointer; color: #9ca3af; }
        .delete-btn:hover { color: #ef4444; }

        .drop-zone { min-height: 60px; padding: 0.5rem; border-radius: 0.5rem; transition: background-color 0.2s; }
        .drop-zone.drag-over { background-color: #dbeafe; }

        [contenteditable]:focus { outline: 2px solid #60a5fa; box-shadow: 0 0 0 2px #bfdbfe; }
        .placeholder-editor { color: #9ca3af; border: 1px dashed #cbd5e1; padding: 2px 4px; border-radius: 4px; background-color: white; }

        /* Color Picker Style */
        .color-picker-wrapper { position: relative; width: 32px; height: 32px; border-radius: 50%; border: 2px solid #e2e8f0; overflow: hidden; }
        .color-picker-wrapper input[type="color"] { position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: pointer; opacity: 0; }
        
        .component-settings { display: none; }
        .component:hover .component-settings { display: flex; }
    </style>
</head>
<body class="bg-slate-100">

    <div id="app" class="flex h-screen">
        <!-- Control Panel -->
        <aside class="w-80 bg-white p-6 shadow-lg overflow-y-auto">
            <h1 class="text-2xl font-bold mb-6 text-slate-800">보고서 빌더</h1>

            <!-- Global Settings -->
            <div class="space-y-4 mb-8 border-b pb-6">
                <h2 class="font-semibold text-slate-600">전체 설정</h2>
                 <div>
                    <label for="report-name" class="text-sm font-medium">보고서 이름</label>
                    <input type="text" id="report-name" value="나의 보고서" class="w-full mt-1 p-2 border rounded-md text-sm">
                </div>
                <div>
                    <label for="paper-size" class="text-sm font-medium">용지 사이즈</label>
                    <select id="paper-size" class="w-full mt-1 p-2 border rounded-md text-sm">
                        <optgroup label="A Series"><option value="a0">A0</option><option value="a1">A1</option><option value="a2">A2</option><option value="a3">A3</option><option value="a4" selected>A4</option></optgroup>
                        <optgroup label="B Series"><option value="b4">B4</option><option value="b5">B5</option></optgroup>
                        <optgroup label="기타"><option value="letter">Letter</option><option value="web">웹 최적화</option></optgroup>
                    </select>
                </div>
                 <div>
                    <label class="text-sm font-medium">테마 색상</label>
                    <div class="flex items-center justify-around mt-2 text-center">
                        <div>
                            <label class="text-xs text-slate-500">배경</label>
                            <div class="color-picker-wrapper mx-auto mt-1" style="background-color: #ffffff;">
                                <input type="color" id="bg-color" value="#ffffff">
                            </div>
                        </div>
                        <div>
                            <label class="text-xs text-slate-500">테마</label>
                            <div class="color-picker-wrapper mx-auto mt-1" style="background-color: #3b82f6;">
                                <input type="color" id="theme-color" value="#3b82f6">
                            </div>
                        </div>
                        <div>
                            <label class="text-xs text-slate-500">글자</label>
                            <div class="color-picker-wrapper mx-auto mt-1" style="background-color: #1e293b;">
                                <input type="color" id="text-color" value="#1e293b">
                            </div>
                        </div>
                        <div>
                            <label class="text-xs text-slate-500">구분선</label>
                            <div class="color-picker-wrapper mx-auto mt-1" style="background-color: #e2e8f0;">
                                <input type="color" id="border-color" value="#e2e8f0">
                            </div>
                        </div>
                    </div>
                </div>
                <div>
                    <label for="font-family" class="text-sm font-medium">기본 글꼴</label>
                    <select id="font-family" class="w-full mt-1 p-2 border rounded-md text-sm">
                        <option value="sans">고딕 (Noto Sans KR)</option>
                        <option value="serif">명조 (Noto Serif KR)</option>
                    </select>
                </div>
            </div>

            <!-- Components -->
            <div>
                <h2 class="font-semibold text-slate-600 mb-4">컴포넌트 추가</h2>
                <div class="grid grid-cols-2 gap-3">
                    <button data-type="h1" class="component-add-btn p-3 bg-slate-50 hover:bg-slate-200 rounded-md text-sm">대제목</button>
                    <button data-type="h2" class="component-add-btn p-3 bg-slate-50 hover:bg-slate-200 rounded-md text-sm">부제목</button>
                    <button data-type="h3" class="component-add-btn p-3 bg-slate-50 hover:bg-slate-200 rounded-md text-sm">중제목</button>
                    <button data-type="h4" class="component-add-btn p-3 bg-slate-50 hover:bg-slate-200 rounded-md text-sm">소제목</button>
                    <button data-type="divider" class="component-add-btn p-3 bg-slate-50 hover:bg-slate-200 rounded-md text-sm">구분선</button>
                    <button data-type="static-markdown" class="component-add-btn p-3 bg-slate-50 hover:bg-slate-200 rounded-md text-sm">자체 설명글</button>
                    <button data-type="markdown" class="component-add-btn p-3 bg-slate-50 hover:bg-slate-200 rounded-md text-sm">마크다운 입력</button>
                    <button data-type="input" class="component-add-btn p-3 bg-slate-50 hover:bg-slate-200 rounded-md text-sm">일반 입력</button>
                    <button data-type="image-upload" class="component-add-btn p-3 bg-slate-50 hover:bg-slate-200 rounded-md text-sm">이미지 입력</button>
                    <button data-type="image-embed" class="component-add-btn p-3 bg-slate-50 hover:bg-slate-200 rounded-md text-sm">이미지 포함</button>
                    <button data-type="code" class="component-add-btn p-3 bg-slate-50 hover:bg-slate-200 rounded-md text-sm">코드 블록</button>
                    <button data-type="group" class="component-add-btn p-3 bg-slate-50 hover:bg-slate-200 rounded-md text-sm font-semibold">그룹 블록</button>
                    <button data-type="columns-2" class="component-add-btn p-3 bg-slate-50 hover:bg-slate-200 rounded-md text-sm">2단</button>
                    <button data-type="columns-3" class="component-add-btn p-3 bg-slate-50 hover:bg-slate-200 rounded-md text-sm">3단</button>
                    <button data-type="interactive" class="component-add-btn col-span-2 p-3 bg-blue-50 hover:bg-blue-100 rounded-md text-sm text-blue-700 font-semibold">인터랙티브 활동</button>
                </div>
            </div>

            <!-- Export -->
            <div class="mt-10">
                <button id="export-html" class="w-full text-white font-bold py-3 px-4 rounded-lg transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    HTML로 내보내기
                </button>
            </div>
        </aside>

        <!-- Preview Panel -->
        <main class="flex-1 p-8 overflow-auto">
            <div id="preview" class="mx-auto shadow-xl p-12 drop-zone">
                <!-- Components will be rendered here -->
            </div>
        </main>
    </div>

    <script>
        const app = {
            config: {
                reportName: '나의 보고서',
                paperSize: 'a4',
                themeColor: '#3b82f6',
                backgroundColor: '#ffffff',
                textColor: '#1e293b',
                borderColor: '#e2e8f0',
                fontFamily: 'sans',
                components: [
                    { id: Date.now(), type: 'h1', content: '보고서 제목을 입력하세요' }
                ]
            },
            
            elements: {
                reportName: document.getElementById('report-name'),
                paperSize: document.getElementById('paper-size'),
                themeColor: document.getElementById('theme-color'),
                bgColor: document.getElementById('bg-color'),
                textColor: document.getElementById('text-color'),
                borderColor: document.getElementById('border-color'),
                fontFamily: document.getElementById('font-family'),
                preview: document.getElementById('preview'),
                exportBtn: document.getElementById('export-html'),
                componentAddBtns: document.querySelectorAll('.component-add-btn'),
            },

            draggedComponent: null,

            init() {
                this.showdownConverter = new showdown.Converter({ strikethrough: true, tables: true, emoji: true });
                this.updateGlobalStyles();
                this.renderPreview();
                this.attachEventListeners();
            },

            attachEventListeners() {
                this.elements.reportName.addEventListener('input', (e) => { this.config.reportName = e.target.value; });
                this.elements.paperSize.addEventListener('change', (e) => { this.config.paperSize = e.target.value; this.updateGlobalStyles(); });
                this.elements.themeColor.addEventListener('input', (e) => { this.config.themeColor = e.target.value; this.updateGlobalStyles(); e.target.parentElement.style.backgroundColor = e.target.value; });
                this.elements.bgColor.addEventListener('input', (e) => { this.config.backgroundColor = e.target.value; this.updateGlobalStyles(); e.target.parentElement.style.backgroundColor = e.target.value; });
                this.elements.textColor.addEventListener('input', (e) => { this.config.textColor = e.target.value; this.updateGlobalStyles(); e.target.parentElement.style.backgroundColor = e.target.value; });
                this.elements.borderColor.addEventListener('input', (e) => { this.config.borderColor = e.target.value; this.updateGlobalStyles(); e.target.parentElement.style.backgroundColor = e.target.value; });
                this.elements.fontFamily.addEventListener('change', (e) => { this.config.fontFamily = e.target.value; this.updateGlobalStyles(); });
                this.elements.componentAddBtns.forEach(btn => btn.addEventListener('click', () => this.addComponent(btn.dataset.type)));
                this.elements.exportBtn.addEventListener('click', () => this.generateHTML());

                const preview = this.elements.preview;
                preview.addEventListener('input', (e) => this.handleInput(e));
                preview.addEventListener('change', (e) => this.handleChange(e));
                preview.addEventListener('click', (e) => this.handleClick(e));
                preview.addEventListener('dragstart', (e) => this.handleDragStart(e));
                preview.addEventListener('dragend', (e) => this.handleDragEnd(e));
                preview.addEventListener('dragover', (e) => this.handleDragOver(e));
                preview.addEventListener('dragenter', (e) => this.handleDragEnter(e));
                preview.addEventListener('dragleave', (e) => this.handleDragLeave(e));
                preview.addEventListener('drop', (e) => this.handleDrop(e));
            },
            
            handleInput(e) {
                const componentEl = e.target.closest('.component');
                if (!componentEl) return;
                const component = this.findComponent(componentEl.dataset.id);
                if (!component) return;

                const field = e.target.dataset.field || 'content';
                if (e.target.isContentEditable) {
                    component[field] = e.target.innerHTML;
                } else {
                    component[field] = e.target.value;
                }
            },

            handleChange(e) {
                if (e.target.matches('input[type="file"].embed-image-input')) {
                    const componentEl = e.target.closest('.component');
                    const component = this.findComponent(componentEl.dataset.id);
                    if (!component || !e.target.files[0]) return;
                    
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        component.content = event.target.result;
                        this.renderPreview();
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            },

            handleClick(e) {
                const deleteBtn = e.target.closest('.delete-btn');
                if(deleteBtn) {
                    const componentId = deleteBtn.closest('.component').dataset.id;
                    this.deleteComponent(componentId);
                }
            },

            handleDragStart(e) {
                if (e.target.closest('.component-handle')) {
                    this.draggedComponent = e.target.closest('.component');
                    setTimeout(() => this.draggedComponent.classList.add('dragging'), 0);
                }
            },
            handleDragEnd() {
                if (this.draggedComponent) {
                    this.draggedComponent.classList.remove('dragging');
                    this.draggedComponent = null;
                    document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                    this.config.components = this.buildDataFromDOM(this.elements.preview);
                }
            },
            handleDragOver(e) {
                e.preventDefault();
                const dropZone = e.target.closest('.drop-zone');
                if (!dropZone || !this.draggedComponent) return;
                const afterElement = this.getDragAfterElement(dropZone, e.clientY);
                if (afterElement == null) {
                    dropZone.appendChild(this.draggedComponent);
                } else {
                    dropZone.insertBefore(this.draggedComponent, afterElement);
                }
            },
            handleDragEnter(e) { e.preventDefault(); const dropZone = e.target.closest('.drop-zone'); if(dropZone) dropZone.classList.add('drag-over'); },
            handleDragLeave(e) { const dropZone = e.target.closest('.drop-zone'); if(dropZone) dropZone.classList.remove('drag-over'); },
            handleDrop(e) { e.preventDefault(); const dropZone = e.target.closest('.drop-zone'); if(dropZone) dropZone.classList.remove('drag-over'); },
            
            getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.component:not(.dragging)')];
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else { return closest; }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            },
            
            updateGlobalStyles() {
                const allSizeClasses = ['preview-a0', 'preview-a1', 'preview-a2', 'preview-a3', 'preview-a4', 'preview-b4', 'preview-b5', 'preview-letter', 'preview-web'];
                this.elements.preview.classList.remove(...allSizeClasses);
                this.elements.preview.classList.add(`preview-${this.config.paperSize}`);
                
                document.documentElement.style.setProperty('--theme-color', this.config.themeColor);
                document.documentElement.style.setProperty('--bg-color', this.config.backgroundColor);
                document.documentElement.style.setProperty('--text-color', this.config.textColor);
                document.documentElement.style.setProperty('--border-color', this.config.borderColor);
                
                this.elements.preview.style.backgroundColor = 'var(--bg-color)';
                this.elements.preview.style.color = 'var(--text-color)';
                
                this.elements.exportBtn.style.backgroundColor = this.config.themeColor;
                this.elements.preview.classList.remove('preview-serif', 'preview-sans');
                this.elements.preview.classList.add(this.config.fontFamily === 'serif' ? 'preview-serif' : 'preview-sans');
            },

            addComponent(type, targetArray = this.config.components) {
                const newComponent = { id: Date.now(), type, content: '' };
                switch(type) {
                    case 'h1': newComponent.content = '대제목'; break;
                    case 'h2': newComponent.content = '부제목'; break;
                    case 'h3': newComponent.content = '중제목'; break;
                    case 'h4': newComponent.content = '소제목'; break;
                    case 'input': newComponent.label = '라벨'; newComponent.placeholder = '안내 문구'; break;
                    case 'static-markdown': newComponent.content = '이곳은 보고서 양식의 일부로, 최종 사용자는 수정할 수 없는 설명글입니다.'; break;
                    case 'markdown': newComponent.content = '사용자가 이 영역에 텍스트를 입력합니다.'; newComponent.height = 150; break;
                    case 'code': newComponent.content = 'print("Hello, World!")'; newComponent.height=200; break;
                    case 'image-embed': newComponent.width = 100; break;
                    case 'image-upload': newComponent.width = 100; break;
                    case 'interactive': newComponent.html = `<div style="padding: 1rem; border: 1px solid #ccc; border-radius: 8px;">\n  <p>카운터: <span id="count-${newComponent.id}">0</span></p>\n  <button id="btn-${newComponent.id}" style="padding: 4px 8px; border-radius: 4px;">증가</button>\n</div>`; newComponent.js = `let count = 0;\nconst countSpan = document.getElementById('count-${newComponent.id}');\ndocument.getElementById('btn-${newComponent.id}').addEventListener('click', () => {\n  count++;\n  countSpan.textContent = count;\n});`; break;
                    case 'columns-2': newComponent.columns = [[], []]; break;
                    case 'columns-3': newComponent.columns = [[], [], []]; break;
                    case 'group': newComponent.children = []; break;
                }
                targetArray.push(newComponent);
                this.renderPreview();
            },
            
            deleteComponent(id, componentArray = this.config.components) {
                const index = componentArray.findIndex(c => c.id == id);
                if (index > -1) {
                    componentArray.splice(index, 1);
                } else {
                    componentArray.forEach(c => {
                        if (c.columns) c.columns.forEach(col => this.deleteComponent(id, col));
                        if (c.children) this.deleteComponent(id, c.children);
                    });
                }
                if (componentArray === this.config.components) this.renderPreview();
            },

            renderPreview(container = this.elements.preview, components = this.config.components) {
                if (container === this.elements.preview) container.innerHTML = '';
                components.forEach(component => {
                    const el = this.createComponentElement(component);
                    container.appendChild(el);
                });
            },

            createComponentElement(component) {
                const div = document.createElement('div');
                div.className = 'component';
                div.dataset.id = component.id;
                
                let contentHtml = '';
                const controls = `<div class="component-controls">
                    <div class="component-handle" draggable="true"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg></div>
                    <div class="delete-btn"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></div>
                </div>`;
                
                const settings = (fields) => `<div class="component-settings absolute top-0 right-0 bg-white/50 backdrop-blur-sm p-1 rounded-bl-lg shadow text-xs items-center gap-2">
                    ${fields}
                </div>`;
                const widthSetting = `<div><label>너비:</label><input type="number" min="10" max="100" value="${component.width}" data-field="width" class="w-12 text-center border rounded"> %</div>`;
                const heightSetting = `<div><label>높이:</label><input type="number" min="50" step="10" value="${component.height}" data-field="height" class="w-16 text-center border rounded"> px</div>`;

                switch(component.type) {
                    case 'h1': contentHtml = `<h1 class="text-4xl font-bold" style="color: var(--theme-color);" contenteditable="true" data-field="content">${component.content}</h1>`; break;
                    case 'h2': contentHtml = `<h2 class="text-2xl font-bold border-b-2 pb-2 mb-4" style="border-color: var(--theme-color);" contenteditable="true" data-field="content">${component.content}</h2>`; break;
                    case 'h3': contentHtml = `<h3 class="text-xl font-semibold" contenteditable="true" data-field="content">${component.content}</h3>`; break;
                    case 'h4': contentHtml = `<h4 class="text-lg font-semibold text-slate-600" contenteditable="true" data-field="content">${component.content}</h4>`; break;
                    case 'input': contentHtml = `<div><label class="font-medium" contenteditable="true" data-field="label">${component.label}</label><div class="w-full border border-slate-300 rounded-md p-2 mt-1"><span class="placeholder-editor" contenteditable="true" data-field="placeholder">${component.placeholder}</span></div></div>`; break;
                    case 'static-markdown': contentHtml = `<div class="prose max-w-none" contenteditable="true" data-field="content">${component.content}</div>`; break;
                    case 'markdown': contentHtml = `<div class="relative prose max-w-none text-slate-400 border-2 border-dashed rounded-lg p-4" style="min-height:${component.height}px">사용자가 마크다운을 입력하는 영역 ${settings(heightSetting)}</div>`; break;
                    case 'code': contentHtml = `<div class="relative"><pre class="bg-slate-800 text-white p-4 rounded-md" style="min-height:${component.height}px"><code contenteditable="true" data-field="content" class="language-python">${component.content}</code></pre>${settings(heightSetting)}</div>`; break;
                    case 'image-upload': contentHtml = `<div class="relative bg-slate-100 border-2 border-dashed rounded-lg flex items-center justify-center h-48 text-slate-500" style="width:${component.width}%; margin: 0 auto;">이미지 입력 영역 ${settings(widthSetting)}</div>`; break;
                    case 'image-embed': 
                        const imgPrev = component.content ? `<img src="${component.content}" class="w-full h-auto object-contain rounded-md">` : '';
                        contentHtml = `<div class="relative flex flex-col items-center justify-center h-auto text-slate-500" style="width:${component.width}%; margin: 0 auto;">
                                        ${imgPrev}
                                        <label for="embed-input-${component.id}" class="mt-2 text-sm bg-slate-200 text-slate-700 font-medium py-1 px-3 rounded-md cursor-pointer hover:bg-slate-300">이미지 선택</label>
                                        <input type="file" accept="image/*" class="embed-image-input hidden" id="embed-input-${component.id}">
                                        ${settings(widthSetting)}
                                       </div>`; 
                        break;
                    case 'interactive': contentHtml = `<div class="border-2 border-dashed border-blue-300 bg-blue-50 p-4 rounded-lg"><h4 class="font-semibold text-blue-800">인터랙티브 활동</h4><div class="mt-2"><label class="text-sm font-medium text-slate-700">HTML</label><textarea data-field="html" class="interactive-code w-full h-24 p-2 mt-1 font-mono text-sm border rounded-md">${component.html}</textarea></div><div class="mt-2"><label class="text-sm font-medium text-slate-700">JavaScript</label><textarea data-field="js" class="interactive-code w-full h-24 p-2 mt-1 font-mono text-sm border rounded-md">${component.js}</textarea></div></div>`; break;
                    case 'divider': contentHtml = `<hr style="border-color: var(--border-color); border-top-width: 2px; margin: 1rem 0;">`; break;
                    
                    case 'columns-2': case 'columns-3': {
                        const numCols = component.type === 'columns-2' ? 2 : 3;
                        const colContainer = document.createElement('div');
                        colContainer.className = 'flex gap-4';
                        for (let i = 0; i < numCols; i++) {
                            const colDiv = document.createElement('div');
                            colDiv.className = 'flex-1 bg-slate-50 p-4 rounded-md border drop-zone';
                            (component.columns[i] || []).forEach(child => colDiv.appendChild(this.createComponentElement(child)));
                            colContainer.appendChild(colDiv);
                        }
                        div.innerHTML = controls;
                        div.appendChild(colContainer);
                        return div;
                    }
                     case 'group': {
                        const groupContainer = document.createElement('div');
                        groupContainer.className = 'border-2 border-dashed p-4 rounded-lg drop-zone'
                        groupContainer.style.borderColor = 'var(--border-color)';
                        (component.children || []).forEach(child => groupContainer.appendChild(this.createComponentElement(child)));
                        div.innerHTML = controls;
                        div.appendChild(groupContainer);
                        return div;
                    }
                }
                div.innerHTML = controls + contentHtml;
                return div;
            },
            
            buildDataFromDOM(container) {
                const components = [];
                container.childNodes.forEach(node => {
                    if (node.nodeType !== Node.ELEMENT_NODE || !node.classList.contains('component')) return;
                    
                    const id = node.dataset.id;
                    const originalComponent = this.findComponent(id);
                    if (!originalComponent) return;

                    const newComponent = { ...originalComponent };

                    if (newComponent.type.startsWith('columns')) {
                        newComponent.columns = [];
                        node.querySelectorAll(':scope > div > .drop-zone').forEach(colNode => {
                            newComponent.columns.push(this.buildDataFromDOM(colNode));
                        });
                    } else if (newComponent.type === 'group') {
                        const groupNode = node.querySelector('.drop-zone');
                        newComponent.children = this.buildDataFromDOM(groupNode);
                    }
                    components.push(newComponent);
                });
                return components;
            },
            
            findComponent(id, components = this.config.components) {
                for(const component of components) {
                    if(component.id == id) return component;
                    if(component.columns) {
                        for(const col of component.columns) {
                            const found = this.findComponent(id, col);
                            if(found) return found;
                        }
                    }
                    if(component.children) {
                        const found = this.findComponent(id, component.children);
                        if(found) return found;
                    }
                }
                return null;
            },

            generateHTML() {
                const generateComponentHTML = (component, isRecursive = false) => {
                    let content = '';
                     switch(component.type) {
                        case 'h1': content = `<h1 class="text-4xl font-bold" style="color: ${this.config.themeColor};">${component.content}</h1>`; break;
                        case 'h2': content = `<h2 class="text-2xl font-bold border-b-2 pb-2" style="border-color: ${this.config.themeColor};">${component.content}</h2>`; break;
                        case 'h3': content = `<h3 class="text-xl font-semibold">${component.content}</h3>`; break;
                        case 'h4': content = `<h4 class="text-lg font-semibold text-slate-600">${component.content}</h4>`; break;
                        case 'input': content = `<div><label class="block font-medium mb-1">${component.label}</label><input type="text" id="input-${component.id}" class="savable w-full p-2 border border-slate-300 rounded-md" placeholder="${component.placeholder}"></div>`; break;
                        case 'static-markdown': content = `<div class="prose max-w-none">${this.showdownConverter.makeHtml(component.content)}</div>`; break;
                        case 'markdown': content = `<div class="editable-container"><textarea class="savable markdown-input hidden w-full p-2 border rounded-md" id="md-${component.id}" placeholder="내용을 입력하세요..." style="min-height: ${component.height}px;"></textarea><div class="markdown-preview prose max-w-none"></div></div>`; break;
                        case 'code': content = `<div class="editable-container"><textarea id="code-${component.id}" class="savable code-input hidden w-full p-2 border rounded-md bg-slate-800 text-white" style="min-height: ${component.height}px;">${component.content}</textarea><pre class="bg-slate-800 rounded-md"><code class="code-preview language-python"></code></pre></div>`; break;
                        case 'image-upload': content = `<div class="screenshot-wrapper" style="width: ${component.width}%; margin: 0 auto;"><label for="screenshot-input-${component.id}" class="flex flex-col items-center justify-center w-full min-h-48 border-2 border-slate-300 border-dashed rounded-lg cursor-pointer bg-slate-50 hover:bg-slate-100"><img id="screenshot-preview-${component.id}" class="hidden w-full h-full object-contain rounded-lg"><div id="screenshot-placeholder-${component.id}" class="text-center text-slate-500 p-4">이미지 첨부</div></label><input type="file" accept="image/*" class="hidden" id="screenshot-input-${component.id}"></div>`; break;
                        case 'image-embed': content = `<img src="${component.content}" class="block w-full h-auto object-contain" style="width: ${component.width}%; margin: 0 auto;">`; break;
                        case 'divider': content = `<hr style="border-color: ${this.config.borderColor}; border-top-width: 2px; margin: 1rem 0;">`; break;
                        case 'columns-2': content = `<div class="flex gap-6">${component.columns.map(col => `<div class="flex-1">${col.map(c => generateComponentHTML(c, true)).join('')}</div>`).join('')}</div>`; break;
                        case 'columns-3': content = `<div class="flex gap-6">${component.columns.map(col => `<div class="flex-1">${col.map(c => generateComponentHTML(c, true)).join('')}</div>`).join('')}</div>`; break;
                        case 'group': content = `<div class="border-2 border-dashed p-4 rounded-lg" style="border-color: ${this.config.borderColor};">${component.children.map(c => generateComponentHTML(c, true)).join('')}</div>`; break;
                        case 'interactive': content = `<div id="interactive-${component.id}">${component.html}</div>`; break;
                    }
                    return isRecursive ? `<div class="report-section mb-8 break-inside-avoid">${content}</div>` : content;
                };

                const bodyContent = `<div id="report-content" class="p-12" style="background-color: ${this.config.backgroundColor}; color: ${this.config.textColor}">${this.config.components.map(c => `<div class="report-section mb-8 break-inside-avoid">${generateComponentHTML(c)}</div>`).join('')}</div>`;
                const styleContent = this.generateStyleHTML();
                const scriptContent = this.generateScriptHTML();
                const overlays = `
    <div id="loader-overlay" class="fixed inset-0 bg-black bg-opacity-60 flex-col items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center">
            <svg class="animate-spin h-10 w-10" style="color: ${this.config.themeColor}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"><\/circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"><\/path>
            <\/svg>
            <p class="text-lg font-semibold text-slate-700 mt-4">PDF 생성 중...<\/p>
        <\/div>
    <\/div>
    <div id="autosave-status" class="no-print fixed bottom-6 right-6 flex items-center bg-slate-800 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-500 z-50">
        <svg id="autosave-icon-saving" class="animate-spin h-5 w-5 mr-3 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"><\/circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"><\/path><\/svg>
        <svg id="autosave-icon-saved" class="h-5 w-5 mr-3 hidden text-green-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /><\/svg>
        <span id="autosave-text"><\/span>
    <\/div>`;

                const fullHtml = `
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${this.config.reportName}<\/title>
    <script src="https://cdn.tailwindcss.com?plugins=typography"><\/script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"><\/script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"><\/script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"><\/script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"><\/script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"><\/script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"><\/script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"><\/script>
    ${styleContent}
<\/head>
<body class="p-4 sm:p-8 bg-slate-100">
    <main class="max-w-4xl mx-auto bg-white shadow-lg">
        ${bodyContent}
    <\/main>
    <footer class="text-center mt-8 py-6 no-print">
        <button id="export-pdf" class="text-white font-bold py-3 px-6 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg flex items-center gap-2 mx-auto" style="background-color: ${this.config.themeColor};">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"><\/path><polyline points="7 10 12 15 17 10"><\/polyline><line x1="12" y1="15" x2="12" y2="3"><\/line><\/svg>
            PDF로 저장
        <\/button>
    </footer>
    ${overlays}
    ${scriptContent}
<\/body>
<\/html>`;
                this.downloadFile(fullHtml, `${this.config.reportName}.html`, 'text/html');
            },

            generateStyleHTML() {
                const fontImport = this.config.fontFamily === 'sans' 
                    ? `@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');`
                    : `@import url('https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;600&display=swap');`;
                const fontFamily = this.config.fontFamily === 'serif' ? "'Noto Serif KR', serif" : "'Noto Sans KR', sans-serif";
                
                return `
<style>
    ${fontImport}
    body { font-family: ${fontFamily}; color: ${this.config.textColor}; }
    .editable-container .prose, .editable-container pre { cursor: text; transition: background-color 0.2s; }
    .editable-container .prose { min-height: 80px; padding: 0.75rem; border-radius: 0.375rem; border: 1px solid transparent; }
    .editable-container .prose:hover, .editable-container pre:hover { background-color: #f8fafc; border-color: #e2e8f0;}
    .code-preview, .code-input { font-family: 'D2Coding', monospace, 'Courier New'; font-size: 0.9rem; line-height: 1.6; }
    .code-preview { padding: 1rem; border-radius: 0.5rem; }
    .no-print { display: block; }
    @media print { .no-print { display: none; } #report-content { margin: 0; padding: 0; box-shadow: none; } }
<\/style>`;
            },
            
            generateScriptHTML() {
                 const interactiveScripts = this.config.components
                    .filter(c => c.type === 'interactive' && c.js)
                    .map(c => `// Interactive component: ${c.id}\n(function() { try { ${c.js} } catch(e) { console.error('Error in interactive component ${c.id}:', e) } })();`)
                    .join('\n\n');

                const mainScript = `
        const config = {
            storageKey: 'exportedReportData_${Date.now()}',
            savableSelector: '.savable',
            screenshotCount: ${this.config.components.filter(c => c.type === 'image-upload').length},
            hasCodeBlock: ${this.config.components.some(c => c.type === 'code')},
            paperSize: '${this.config.paperSize}'
        };
        const converter = new showdown.Converter({ simpleLineBreaks: true, tables: true, strikethrough: true, ghCompatibleHeaderId: true, emoji: true });
        const exportBtn = document.getElementById('export-pdf');
        let saveTimer;

        function showSaveStatus(state) {
            const statusEl = document.getElementById('autosave-status');
            if(!statusEl) return;
            const textEl = statusEl.querySelector('#autosave-text');
            const iconSaving = statusEl.querySelector('#autosave-icon-saving');
            const iconSaved = statusEl.querySelector('#autosave-icon-saved');
            statusEl.classList.remove('opacity-0');
            if (state === 'saved') {
                textEl.textContent = '저장 완료';
                iconSaving.classList.add('hidden');
                iconSaved.classList.remove('hidden');
                setTimeout(() => statusEl.classList.add('opacity-0'), 2000);
            } else {
                textEl.textContent = '저장 중...';
                iconSaving.classList.remove('hidden');
                iconSaved.classList.add('hidden');
            }
        }
        
        function saveContent() {
            clearTimeout(saveTimer);
            showSaveStatus('saving');
            saveTimer = setTimeout(() => {
                const data = {};
                document.querySelectorAll(config.savableSelector).forEach(el => data[el.id] = el.value);
                // Also save image data if any
                document.querySelectorAll('input[type="file"]').forEach(input => {
                    const preview = document.getElementById(input.id.replace('input', 'preview'));
                    if (preview && preview.src && !preview.src.endsWith('#')) data[preview.id] = preview.src;
                });
                localStorage.setItem(config.storageKey, JSON.stringify(data));
                showSaveStatus('saved');
            }, 1000);
        }

        function loadSavedContent() {
            const data = JSON.parse(localStorage.getItem(config.storageKey));
            if (!data) return;
            document.querySelectorAll(config.savableSelector).forEach(el => {
                if(data[el.id]) el.value = data[el.id];
            });
            document.querySelectorAll('img[id^="screenshot-preview-"]').forEach(img => {
                 if(data[img.id]) {
                     img.src = data[img.id];
                     img.classList.remove('hidden');
                     const placeholder = document.getElementById(img.id.replace('preview', 'placeholder'));
                     if(placeholder) placeholder.classList.add('hidden');
                 }
            });
        }

        function updateMarkdownPreview(textareaElement) {
            const container = textareaElement.closest('.editable-container');
            if (!container) return;
            const preview = container.querySelector('.markdown-preview');
            if (preview) {
                const placeholder = '<p class="text-slate-400">' + (textareaElement.placeholder || '내용을 입력하세요...') + '<\\/p>';
                const html = textareaElement.value ? converter.makeHtml(textareaElement.value) : placeholder;
                preview.innerHTML = html;
                if(window.renderMathInElement) renderMathInElement(preview, { delimiters: [{left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}] });
            }
        }

        function updateCodePreview() {
            if (!config.hasCodeBlock || typeof hljs === 'undefined') return;
            document.querySelectorAll('.code-input').forEach(textarea => {
                const container = textarea.closest('.editable-container');
                if (!container) return;
                const preview = container.querySelector('.code-preview');
                if (preview) {
                    preview.textContent = textarea.value || '// 코드를 입력하세요...';
                    delete preview.dataset.highlighted;
                    hljs.highlightElement(preview);
                }
            });
        }
        
        function autoResizeTextarea(textarea) { textarea.style.height = 'auto'; textarea.style.height = (textarea.scrollHeight) + 'px'; }

        function loadContent() {
            loadSavedContent();
            document.querySelectorAll('.markdown-input').forEach(updateMarkdownPreview);
            if (config.hasCodeBlock) updateCodePreview();
        }
        
        async function exportToPdf() {
            const loader = document.getElementById('loader-overlay');
            if(loader) loader.style.display = 'flex';
            const reportContent = document.getElementById('report-content');
            try {
                const { jsPDF } = window.jspdf;
                let format = config.paperSize.startsWith('a') || config.paperSize.startsWith('b') ? config.paperSize : 'a4';
                const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: format });
                
                document.querySelectorAll('.editable-container textarea').forEach(el => el.style.display = 'none');
                document.querySelectorAll('.editable-container .markdown-preview, .editable-container pre').forEach(el => el.style.display = 'block');
                
                const canvas = await html2canvas(reportContent, {
                     scale: 2,
                     useCORS: true,
                     windowWidth: reportContent.scrollWidth,
                     windowHeight: reportContent.scrollHeight
                });
                
                document.querySelectorAll('.editable-container textarea').forEach(el => el.style.display = '');
                document.querySelectorAll('.editable-container .markdown-preview, .editable-container pre').forEach(el => el.style.display = '');

                const imgData = canvas.toDataURL('image/png');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const imgHeight = (canvas.height * pdfWidth) / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;
                
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, imgHeight);
                heightLeft -= pdfHeight;

                while (heightLeft > 0) {
                    position = -heightLeft;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                    heightLeft -= pdfHeight;
                }
                pdf.save(document.title + '.pdf');
            } catch(e) { console.error("PDF Export Error:", e); }
            finally { if(loader) loader.style.display = 'none'; }
        }

        function initialize() {
            document.querySelectorAll('.editable-container').forEach(container => {
                const preview = container.querySelector('.markdown-preview, pre');
                const editor = container.querySelector('textarea');
                if (preview && editor) {
                    preview.addEventListener('click', () => {
                        preview.classList.add('hidden');
                        editor.classList.remove('hidden');
                        editor.focus();
                        autoResizeTextarea(editor);
                    });
                    editor.addEventListener('blur', () => {
                        editor.classList.add('hidden');
                        preview.classList.remove('hidden');
                        if (editor.classList.contains('code-input')) updateCodePreview();
                        else updateMarkdownPreview(editor);
                        saveContent();
                    });
                }
            });
            document.querySelectorAll('input[type="file"]').forEach(input => {
                input.addEventListener('change', (event) => {
                    const preview = document.getElementById(input.id.replace('input', 'preview'));
                    const placeholder = document.getElementById(input.id.replace('input', 'placeholder'));
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            preview.src = e.target.result;
                            preview.classList.remove('hidden');
                            if (placeholder) placeholder.classList.add('hidden');
                            saveContent();
                        };
                        reader.readAsDataURL(file);
                    }
                });
            });
            document.querySelectorAll('.savable').forEach(el => el.addEventListener('input', saveContent));
            if (exportBtn) exportBtn.addEventListener('click', exportToPdf);
            loadContent();
        }
        
        initialize();
        
        // --- Appended Interactive Scripts ---
        ${interactiveScripts}
    `;
                 return `<script>document.addEventListener('DOMContentLoaded', () => { try { ${mainScript} } catch(e) { console.error('Error initializing report script:', e); } });<\/script>`;
            },
            
            downloadFile(content, fileName, contentType) {
                const a = document.createElement("a");
                const file = new Blob([content], { type: contentType });
                a.href = URL.createObjectURL(file);
                a.download = fileName;
                a.click();
                URL.revokeObjectURL(a.href);
            },
        };

        app.init();
    </script>
</body>
</html>

